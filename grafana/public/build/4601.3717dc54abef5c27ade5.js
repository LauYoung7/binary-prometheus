(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4601],{14601:(Le,O,f)=>{"use strict";f.r(O),f.d(O,{plugin:()=>ha});var L=f(7238),pe=f(55294),_=f(82378),p=f(52423),i=f(68404),K=f(69311),be=f(45253),re=f(72648),ce=f(69659),fe=f(77117),v=f(81764),M=f(46967);const _e=t=>(e,s)=>{const n={};for(const a in t)n[a]=t[a](e[a],s);return n},Ee=(t,e,s)=>(0,i.useCallback)(a=>{t(s(e,a))},[t,e,s]),le=(0,i.createContext)(void 0),j=()=>{const t=(0,i.useContext)(le);if(!t)throw new Error("Use DispatchContext first.");return t},Te=t=>({name:t,pipelineAgg:""}),o=t=>`var${Math.max(0,...t.map(e=>parseInt(e.name.match("^var(\\d+)$")?.[1]||"0",10)))+1}`,b=t=>t.settings?.model==="ewma",y=t=>t.settings?.model==="holt",S=t=>t.settings?.model==="holt_winters",D=t=>["holt","ewma","holt_winters"].includes(t.settings?.model||""),w=t=>C[t.type].requiresField,F=t=>C[t.type].isPipelineAgg,q=t=>C[t.type].supportsMultipleBucketPaths,P=t=>C[t.type].supportsMissing,N=t=>C[t.type].hasSettings,T=t=>C[t.type].hasMeta,R=t=>C[t.type].supportsInlineScript,ie=["count","avg","sum","min","max","extended_stats","percentiles","cardinality","raw_document","raw_data","logs","moving_avg","moving_fn","derivative","serial_diff","cumulative_sum","bucket_script","rate","top_metrics"],ue=t=>ie.includes(t),C={count:{label:"Count",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!1,hasMeta:!1,supportsInlineScript:!1,defaults:{}},avg:{label:"Average",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},sum:{label:"Sum",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},max:{label:"Max",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},min:{label:"Min",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},extended_stats:{label:"Extended Stats",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!0,defaults:{meta:{std_deviation_bounds_lower:!0,std_deviation_bounds_upper:!0}}},percentiles:{label:"Percentiles",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{settings:{percents:["25","50","75","95","99"]}}},cardinality:{label:"Unique Count",requiresField:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},moving_avg:{label:"Moving Average",requiresField:!0,isPipelineAgg:!0,versionRange:"<8.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{model:"simple",window:"5"}}},moving_fn:{label:"Moving Function",requiresField:!0,isPipelineAgg:!0,supportsMultipleBucketPaths:!1,supportsInlineScript:!1,supportsMissing:!1,hasMeta:!1,hasSettings:!0,defaults:{}},derivative:{label:"Derivative",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},serial_diff:{label:"Serial Difference",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{lag:"1"}}},cumulative_sum:{label:"Cumulative Sum",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},bucket_script:{label:"Bucket Script",requiresField:!1,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!0,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{pipelineVariables:[Te(o([]))]}},raw_document:{label:"Raw Document (deprecated)",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},raw_data:{label:"Raw Data",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},logs:{label:"Logs",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,isSingleMetric:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{limit:"500"}}},top_metrics:{label:"Top Metrics",xpack:!0,requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{order:"desc"}}},rate:{label:"Rate",xpack:!0,requiresField:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!0,hasMeta:!1,defaults:{}}},Z={moving_avg:[{label:"window",default:5},{label:"model",default:"simple"},{label:"predict"},{label:"minimize",default:!1}],moving_fn:[{label:"window",default:5},{label:"script"}],derivative:[{label:"unit"}],serial_diff:[{label:"lag"}],cumulative_sum:[{label:"format"}],bucket_script:[]},I=(t,e)=>{const s=e.filter(n=>q(n)?n.pipelineVariables?.some(a=>a.pipelineAgg===t.id):w(n)&&t.id===n.field);return[...s,...s.flatMap(n=>I(n,e))]},W=[{label:"Avg",value:"avg"},{label:"Min",value:"min"},{label:"Max",value:"max"},{label:"Sum",value:"sum"},{label:"Count",value:"count"},{label:"Std Dev",value:"std_deviation"},{label:"Std Dev Upper",value:"std_deviation_bounds_upper"},{label:"Std Dev Lower",value:"std_deviation_bounds_lower"}],he=[{label:"Simple",value:"simple"},{label:"Linear",value:"linear"},{label:"Exponentially Weighted",value:"ewma"},{label:"Holt Linear",value:"holt"},{label:"Holt Winters",value:"holt_winters"}],se={pre:"@HIGHLIGHT@",post:"@/HIGHLIGHT@"};function Se(t="1"){return{type:"count",id:t}}function de(t="1"){return{type:"date_histogram",id:t,settings:{interval:"auto"}}}const k=(t,e)=>t.find(s=>s.id===e);function We(t,e){return!!t?.metrics?.some(s=>s.type===e)}function os(t){return t in Z}function cs(t){return!!C[t].supportsMultipleBucketPaths}var De=f(5048);const ve=t=>w(t)?`${C[t.type].label} ${t.field}`:C[t.type].label,Qe=t=>Object.entries(t).reduce((e,[s,n])=>{if(n==null)return{...e};if(Array.isArray(n)&&n.length===0)return{...e};if(typeof n=="string"&&n.length===0)return{...e};if(!Array.isArray(n)&&typeof n=="object"){const a=Qe(n);return Object.keys(a).length===0?{...e}:{...e,[s]:a}}return{...e,[s]:n}},{}),lt=t=>{const e=t.match(/^(\d+)/);return e?e[1]:void 0},xe=t=>(typeof t.settings?.script=="object"?t.settings?.script?.inline:t.settings?.script)||"",ot=t=>{if(typeof t=="string")return(0,De.valid)(t)||"8.0.0";switch(t){case 2:return"2.0.0";case 5:return"5.0.0";case 56:return"5.6.0";case 60:return"6.0.0";case 70:return"7.0.0";default:return"8.0.0"}},ze=t=>!!(0,De.gte)(t,"7.10.0");var V=f(32557);const ct=(0,V.PH)("@metrics/add"),ut=(0,V.PH)("@metrics/remove"),dt=(0,V.PH)("@metrics/toggle_visibility"),He=(0,V.PH)("@metrics/change_field"),Ke=(0,V.PH)("@metrics/change_type"),gt=(0,V.PH)("@metrics/change_attr"),B=(0,V.PH)("@metrics/change_setting"),mt=(0,V.PH)("@metrics/change_meta"),Ce=(0,V.PH)("init"),pt=(0,V.PH)("change_query"),ft=(0,V.PH)("change_alias_pattern"),us=(t,e)=>pt.match(e)?e.payload:Ce.match(e)?t||"":t,ds=(t,e)=>ft.match(e)?e.payload:Ce.match(e)?t||"":t;var qe=f(38306);const ht=()=>({label:"",query:"*"}),A={terms:{label:"Terms",requiresField:!0,defaultSettings:{min_doc_count:"1",size:"10",order:"desc",orderBy:"_term"}},filters:{label:"Filters",requiresField:!1,defaultSettings:{filters:[ht()]}},geohash_grid:{label:"Geo Hash Grid",requiresField:!0,defaultSettings:{precision:"3"}},date_histogram:{label:"Date Histogram",requiresField:!0,defaultSettings:{interval:"auto",min_doc_count:"0",trimEdges:"0",timeZone:qe.RQ.utc}},histogram:{label:"Histogram",requiresField:!0,defaultSettings:{interval:"1000",min_doc_count:"0"}},nested:{label:"Nested (experimental)",requiresField:!0,defaultSettings:{}}},vt=[{label:"Term value",value:"_term"},{label:"Doc Count",value:"_count"}],Ue=[{label:"Top",value:"desc"},{label:"Bottom",value:"asc"}],gs=[{label:"No limit",value:"0"},{label:"1",value:"1"},{label:"2",value:"2"},{label:"3",value:"3"},{label:"5",value:"5"},{label:"10",value:"10"},{label:"15",value:"15"},{label:"20",value:"20"}],yt=(0,V.PH)("@bucketAggs/add"),bt=(0,V.PH)("@bucketAggs/remove"),Et=(0,V.PH)("@bucketAggs/change_type"),St=(0,V.PH)("@bucketAggs/change_field"),Q=(0,V.PH)("@bucketAggs/change_setting"),ms=t=>(e,s)=>{if(yt.match(s)){const n={id:s.payload,type:"terms",settings:A.terms.defaultSettings},a=e[e.length-1];return a?.type==="date_histogram"?[...e.slice(0,e.length-1),n,a]:[...e,n]}return bt.match(s)?e.filter(n=>n.id!==s.payload):Et.match(s)?e.map(n=>n.id!==s.payload.id?n:{id:n.id,type:s.payload.newType,settings:A[s.payload.newType].defaultSettings}):St.match(s)?e.map(n=>n.id!==s.payload.id?n:{...n,field:s.payload.newField}):Ke.match(s)?C[s.payload.type].isSingleMetric?[]:e.length===0?[{...de("2"),field:t}]:e:Q.match(s)?e.map(n=>{if(n.id!==s.payload.bucketAgg.id)return n;const a=Qe({...n.settings,[s.payload.settingName]:s.payload.newValue});return{...n,settings:{...a}}}):Ce.match(s)?e?.length||0>0?e:[{...de("2"),field:t}]:e},ps=(t,e)=>{if(ct.match(e))return[...t,Se(e.payload)];if(ut.match(e)){const s=t.find(r=>r.id===e.payload),n=[s,...I(s,t)],a=t.filter(r=>!n.some(l=>l.id===r.id));return a.length===0?[Se("1")]:a}return Ke.match(e)?t.filter(s=>C[e.payload.type].isSingleMetric?s.id===e.payload.id:!0).map(s=>s.id!==e.payload.id?s:{id:s.id,type:e.payload.type,...C[e.payload.type].defaults}):He.match(e)?t.map(s=>{if(s.id!==e.payload.id)return s;const n={...s,field:e.payload.field};return F(s)?{...n,pipelineAgg:e.payload.field}:n}):dt.match(e)?t.map(s=>s.id!==e.payload?s:{...s,hide:!s.hide}):B.match(e)?t.map(s=>{if(s.id!==e.payload.metric.id)return s;if(N(s)){const n=Qe({...s.settings,[e.payload.settingName]:e.payload.newValue});return{...s,settings:{...n}}}return s}):mt.match(e)?t.map(s=>s.id!==e.payload.metric.id?s:T(s)?{...s,meta:{...s.meta,[e.payload.meta]:e.payload.newValue}}:s):gt.match(e)?t.map(s=>s.id!==e.payload.metric.id?s:{...s,[e.payload.attribute]:e.payload.newValue}):Ce.match(e)?t?.length||0>0?t:[Se("1")]:t},Ft=(0,i.createContext)(void 0),It=(0,i.createContext)(void 0),wt=(0,i.createContext)(void 0),fs=({children:t,onChange:e,onRunQuery:s,query:n,datasource:a,range:r})=>{const l=(0,i.useCallback)(h=>{e(h),s()},[e,s]),u=_e({query:us,alias:ds,metrics:ps,bucketAggs:ms(a.timeField)}),c=Ee(h=>l({...n,...h,timeField:a.timeField}),n,u),d=!n.metrics||!n.bucketAggs||n.query===void 0,[g,m]=(0,i.useState)(d);return(0,i.useEffect)(()=>{g&&(c(Ce()),m(!1))},[g,c]),d?null:i.createElement(Ft.Provider,{value:a},i.createElement(It.Provider,{value:n},i.createElement(wt.Provider,{value:r},i.createElement(le.Provider,{value:c},t))))},Je=t=>()=>{const e=(0,i.useContext)(t);if(!e)throw new Error("use ElasticsearchProvider first.");return e},ye=Je(It),Mt=Je(Ft),hs=Je(wt),Dt=t=>t.id,vs=t=>parseInt(t,10),ys=()=>{const{metrics:t,bucketAggs:e}=ye();return(0,i.useMemo)(()=>(Math.max(...[...t?.map(Dt)||["0"],...e?.map(Dt)||["0"]].map(vs))+1).toString(),[t,e])};var xt=f(39904);const bs=p.css`
  clip: rect(0 0 0 0);
  clip-path: inset(50%);
  height: 1px;
  overflow: hidden;
  position: absolute;
  white-space: nowrap;
  width: 1px;
`,ke=({iconName:t,onClick:e,className:s,label:n,...a})=>i.createElement("button",{className:(0,p.cx)("gf-form-label gf-form-label--btn query-part",s),onClick:e,...a},i.createElement("span",{className:bs},n),i.createElement(xt.J,{name:t,"aria-hidden":"true"}));var E=f(82897),Es=f(11543),je=f(62157),Ct=f(8180);const Ot=({children:t,label:e,onRemoveClick:s,onHideClick:n,hidden:a=!1})=>{const r=(0,re.wW)(Ss);return i.createElement(Es.Z,null,i.createElement(je.m,null,i.createElement(fe.W,{width:17,as:"div"},i.createElement("span",null,e),i.createElement("span",{className:r.iconWrapper},n&&i.createElement(Ct.h,{name:a?"eye-slash":"eye",onClick:n,size:"sm","aria-pressed":a,"aria-label":"hide metric",className:r.icon,type:"button"}),i.createElement(Ct.h,{name:"trash-alt",size:"sm",className:r.icon,onClick:s||E.noop,disabled:!s,"aria-label":"remove metric",type:"button"})))),t)},Ss=t=>({iconWrapper:p.css`
      display: flex;
    `,icon:p.css`
      color: ${t.colors.text.secondary};
      margin-left: ${t.spacing(.25)};
    `});var Ge=f(70044),Ye=f(68118),ge=f(3363);const Pt=t=>A[t.type].requiresField,Fs=["date_histogram","histogram","terms","filters","geohash_grid","nested"],Is=t=>Fs.includes(t),ws=t=>{if(ue(t))switch(t){case"cardinality":return[];case"top_metrics":return["number"];default:return["number"]}if(Is(t))switch(t){case"date_histogram":return["date"];case"geohash_grid":return["geo_point"];case"histogram":return["number"];default:return[]}return[]},Ms=({text:t})=>({label:t,value:t}),Re=t=>{const e=Mt(),s=hs(),n=Array.isArray(t)?t:ws(t);let a;return async r=>(a||(a=await(0,ge.n)(e.getFields(n,s))),a.filter(({text:l})=>r===void 0||l.includes(r)).map(Ms))},Fe=p.css`
  min-width: 150px;
`,Ds=(t,e)=>({wrapper:p.css`
      max-width: 500px;
      display: flex;
      flex-direction: column;
    `,settingsWrapper:p.css`
      padding-top: ${t.spacing(.5)};
    `,icon:p.css`
      margin-right: ${t.spacing(.5)};
    `,button:p.css`
      justify-content: start;
      ${e&&p.css`
        color: ${t.colors.text.disabled};
      `}
    `}),Vt=({label:t,children:e,hidden:s=!1})=>{const[n,a]=(0,i.useState)(!1),r=(0,re.l4)(),l=Ds(r,s);return i.createElement(je.m,null,i.createElement("div",{className:(0,p.cx)(l.wrapper)},i.createElement("button",{className:(0,p.cx)("gf-form-label query-part",l.button,Fe),onClick:()=>a(!n),"aria-expanded":n,type:"button"},i.createElement(xt.J,{name:n?"angle-down":"angle-right","aria-hidden":"true",className:l.icon}),t),n&&i.createElement("div",{className:l.settingsWrapper},e)))};var ne=f(53217),xs=f(52566);const Cs=t=>({value:e})=>e===t,Os=(t,e)=>e===void 0||t.some(Cs(e))?t:[...t,{value:e,label:e}],Nt=({options:t,value:e,onChange:s})=>{const[n,a]=(0,i.useState)(Os(t,e)),r=l=>a([...n,{value:l,label:l}]);return{onCreateOption:l=>{r(l),s({value:l})},onChange:s,allowCustomValue:!0,options:n,value:e}},Ps=[{label:"auto",value:"auto"},{label:"10s",value:"10s"},{label:"1m",value:"1m"},{label:"5m",value:"5m"},{label:"10m",value:"10m"},{label:"20m",value:"20m"},{label:"1h",value:"1h"},{label:"1d",value:"1d"}],Vs=t=>({value:e})=>e===t,Ns=(t,e,s)=>!s.some(Vs(t))&&t.trim().length>0,As=(t,e)=>t.value?.startsWith(e)||!1,_s=({bucketAgg:t})=>{const e=j(),{current:s}=(0,i.useRef)((0,E.uniqueId)("es-date_histogram-")),n=({value:a})=>e(Q({bucketAgg:t,settingName:"interval",newValue:a}));return i.createElement(i.Fragment,null,i.createElement(v._,{label:"Interval",...J},i.createElement(ne.Ph,{inputId:(0,E.uniqueId)("es-date_histogram-interval"),isValidNewOption:Ns,filterOption:As,...Nt({options:Ps,value:t.settings?.interval||A.date_histogram.defaultSettings?.interval,onChange:n})})),i.createElement(v._,{label:"Min Doc Count",...J},i.createElement(M.I,{id:`${s}-min_doc_count`,onBlur:a=>e(Q({bucketAgg:t,settingName:"min_doc_count",newValue:a.target.value})),defaultValue:t.settings?.min_doc_count||A.date_histogram.defaultSettings?.min_doc_count})),i.createElement(v._,{label:"Trim Edges",...J,tooltip:"Trim the edges on the timeseries datapoints"},i.createElement(M.I,{id:`${s}-trime_edges`,onBlur:a=>e(Q({bucketAgg:t,settingName:"trimEdges",newValue:a.target.value})),defaultValue:t.settings?.trimEdges||A.date_histogram.defaultSettings?.trimEdges})),i.createElement(v._,{label:"Offset",...J,tooltip:"Change the start value of each bucket by the specified positive (+) or negative offset (-) duration, such as 1h for an hour, or 1d for a day"},i.createElement(M.I,{id:`${s}-offset`,onBlur:a=>e(Q({bucketAgg:t,settingName:"offset",newValue:a.target.value})),defaultValue:t.settings?.offset||A.date_histogram.defaultSettings?.offset})),i.createElement(v._,{label:"Timezone",...J},i.createElement(xs.O,{value:t.settings?.timeZone||A.date_histogram.defaultSettings?.timeZone,includeInternal:[qe.RQ.utc],onChange:a=>{e(Q({bucketAgg:t,settingName:"timeZone",newValue:a}))}})))},At=({index:t,onAdd:e,onRemove:s,elements:n})=>i.createElement("div",{className:p.css`
        display: flex;
      `},t===0&&i.createElement(ke,{iconName:"plus",onClick:e,label:"add"}),n.length>=2&&i.createElement(ke,{iconName:"minus",onClick:s,label:"remove"})),Ze=(0,V.PH)("@bucketAggregations/filter/add"),_t=(0,V.PH)("@bucketAggregations/filter/remove"),Xe=(0,V.PH)("@bucketAggregations/filter/change"),Ts=(t=[],e)=>Ze.match(e)?[...t,ht()]:_t.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):Xe.match(e)?t.map((s,n)=>n!==e.payload.index?s:e.payload.filter):t,ks=({bucketAgg:t})=>{const{current:e}=(0,i.useRef)((0,E.uniqueId)("es-filters-")),s=j(),n=Ee(a=>s(Q({bucketAgg:t,settingName:"filters",newValue:a})),t.settings?.filters,Ts);return(0,i.useEffect)(()=>{t.settings?.filters?.length||n(Ze())},[n,t.settings?.filters?.length]),i.createElement(i.Fragment,null,i.createElement("div",{className:p.css`
          display: flex;
          flex-direction: column;
        `},t.settings?.filters.map((a,r)=>i.createElement("div",{key:r,className:p.css`
              display: flex;
            `},i.createElement(v._,{label:"Query",labelWidth:8},i.createElement("div",{className:p.css`
                  width: 150px;
                `},i.createElement(ce.q,{placeholder:"Lucene Query",portalOrigin:"elasticsearch",onBlur:()=>{},onChange:l=>n(Xe({index:r,filter:{...a,query:l}})),query:a.query}))),i.createElement(v._,{label:"Label",labelWidth:8},i.createElement(M.I,{width:16,id:`${e}-label-${r}`,placeholder:"Label",onBlur:l=>n(Xe({index:r,filter:{...a,label:l.target.value}})),defaultValue:a.label})),i.createElement(At,{index:r,elements:t.settings?.filters||[],onAdd:()=>n(Ze()),onRemove:()=>n(_t(r))})))))},js=({bucketAgg:t})=>{const{metrics:e}=ye(),s=Ls(e),{current:n}=(0,i.useRef)((0,E.uniqueId)("es-terms-")),a=j();return i.createElement(i.Fragment,null,i.createElement(v._,{label:"Order",...J},i.createElement(ne.Ph,{inputId:`${n}-order`,onChange:r=>a(Q({bucketAgg:t,settingName:"order",newValue:r.value})),options:Ue,value:t.settings?.order||A.terms.defaultSettings?.order})),i.createElement(v._,{label:"Size",...J},i.createElement(ne.Ph,{inputId:`${n}-size`,...Nt({options:gs,value:t.settings?.size||A.terms.defaultSettings?.size,onChange({value:r}){a(Q({bucketAgg:t,settingName:"size",newValue:r}))}})})),i.createElement(v._,{label:"Min Doc Count",...J},i.createElement(M.I,{id:`${n}-min_doc_count`,onBlur:r=>a(Q({bucketAgg:t,settingName:"min_doc_count",newValue:r.target.value})),defaultValue:t.settings?.min_doc_count||A.terms.defaultSettings?.min_doc_count})),i.createElement(v._,{label:"Order By",...J},i.createElement(ne.Ph,{inputId:`${n}-order_by`,onChange:r=>a(Q({bucketAgg:t,settingName:"orderBy",newValue:r.value})),options:s,value:t.settings?.orderBy||A.terms.defaultSettings?.orderBy})),i.createElement(v._,{label:"Missing",...J},i.createElement(M.I,{id:`${n}-missing`,onBlur:r=>a(Q({bucketAgg:t,settingName:"missing",newValue:r.target.value})),defaultValue:t.settings?.missing||A.terms.defaultSettings?.missing})))};function Rs(t){return t.meta?Object.keys(t.meta).filter(s=>t.meta?.[s]).map(s=>{let n=s;return s==="std_deviation_bounds_lower"&&(n="std_lower"),s==="std_deviation_bounds_upper"&&(n="std_upper"),{label:`${ve(t)} (${n})`,value:`${t.id}[${n}]`}}):[]}function Bs(t){return t.settings?.percents?t.settings.percents.map(e=>{const s=/^\d+\.\d+/.test(`${e}`)?e:`${e}.0`;return{label:`${ve(t)} (${e})`,value:`${t.id}[${s}]`}}):[]}function $s(t){return t.type!=="top_metrics"&&!F(t)}const Ls=(t=[])=>{const e=t.filter($s).flatMap(s=>s.type==="extended_stats"?Rs(s):s.type==="percentiles"?Bs(s):{label:ve(s),value:s.id});return[...vt,...e]},Tt=t=>e=>e.value===t,Ws=t=>{const{metrics:e}=ye();switch(t.type){case"terms":{const s=t.settings?.order||"desc",n=t.settings?.size||"10",a=parseInt(t.settings?.min_doc_count||"0",10),r=t.settings?.orderBy||"_term";let l="";n!=="0"&&(l=`${Ue.find(Tt(s))?.label} ${n}, `),a>0&&(l+=`Min Doc Count: ${a}, `),l+="Order by: ";const u=vt.find(Tt(r));if(u)l+=u.label;else{const c=e?.find(d=>d.id===lt(r));c?l+=ve(c):l+="metric not found"}return n==="0"&&(l+=` (${s})`),l}case"histogram":{const s=t.settings?.interval||1e3,n=t.settings?.min_doc_count||1;return`Interval: ${s}${n>0?`, Min Doc Count: ${n}`:""}`}case"filters":return`Filter Queries (${(t.settings?.filters||A.filters.defaultSettings?.filters).length})`;case"geohash_grid":return`Precision: ${Math.max(Math.min(parseInt(t.settings?.precision||"5",10),12),1)}`;case"date_histogram":{const s=t.settings?.interval||"auto",n=t.settings?.min_doc_count||0,a=t.settings?.trimEdges||0;let r=`Interval: ${s}`;return n>0&&(r+=`, Min Doc Count: ${n}`),a>0&&(r+=`, Trim edges: ${a}`),r}default:return"Settings"}},J={labelWidth:16},Qs=({bucketAgg:t})=>{const{current:e}=(0,i.useRef)((0,E.uniqueId)("es-setting-")),s=j(),n=Ws(t);return i.createElement(Vt,{label:n},t.type==="terms"&&i.createElement(js,{bucketAgg:t}),t.type==="date_histogram"&&i.createElement(_s,{bucketAgg:t}),t.type==="filters"&&i.createElement(ks,{bucketAgg:t}),t.type==="geohash_grid"&&i.createElement(v._,{label:"Precision",...J},i.createElement(M.I,{id:`${e}-geohash_grid-precision`,onBlur:a=>s(Q({bucketAgg:t,settingName:"precision",newValue:a.target.value})),defaultValue:t.settings?.precision||A[t.type].defaultSettings?.precision})),t.type==="histogram"&&i.createElement(i.Fragment,null,i.createElement(v._,{label:"Interval",...J},i.createElement(M.I,{id:`${e}-histogram-interval`,onBlur:a=>s(Q({bucketAgg:t,settingName:"interval",newValue:a.target.value})),defaultValue:t.settings?.interval||A[t.type].defaultSettings?.interval})),i.createElement(v._,{label:"Min Doc Count",...J},i.createElement(M.I,{id:`${e}-histogram-min_doc_count`,onBlur:a=>s(Q({bucketAgg:t,settingName:"min_doc_count",newValue:a.target.value})),defaultValue:t.settings?.min_doc_count||A[t.type].defaultSettings?.min_doc_count}))))},zs=Object.entries(A).map(([t,{label:e}])=>({label:e,value:t})),Hs=t=>({label:A[t.type].label,value:t.type}),Ks=({value:t})=>{const e=j(),s=Re(t.type);return i.createElement(i.Fragment,null,i.createElement(je.m,null,i.createElement(Ge.X,{className:Fe,options:zs,onChange:n=>e(Et({id:t.id,newType:n.value})),value:Hs(t)}),Pt(t)&&i.createElement(Ye.V,{className:Fe,loadOptions:s,onChange:n=>e(St({id:t.id,newField:n.value})),placeholder:"Select Field",value:t.field})),i.createElement(Qs,{bucketAgg:t}))},qs=({nextId:t})=>{const e=j(),{bucketAggs:s}=ye(),n=s?.length||0;return i.createElement(i.Fragment,null,s.map((a,r)=>i.createElement(Ot,{key:`${a.type}-${a.id}`,label:r===0?"Group By":"Then By",onRemoveClick:n>1&&(()=>e(bt(a.id)))},i.createElement(Ks,{value:a}),r===0&&i.createElement(ke,{iconName:"plus",onClick:()=>e(yt(t)),label:"add"}))))},Us=p.css`
  white-space: nowrap;
`,kt=t=>({label:ve(t),value:t}),Js=t=>t.map(kt),jt=({options:t,onChange:e,className:s,value:n})=>{const a=t.find(r=>r.id===n);return i.createElement(Ge.X,{className:(0,p.cx)(s,Us),options:Js(t),onChange:e,placeholder:"Select Metric",value:a?kt(a):void 0})};var Oe=f(8944);function U({label:t,settingName:e,metric:s,placeholder:n,tooltip:a}){const r=j(),[l]=(0,i.useState)((0,E.uniqueId)("es-field-id-"));let c=s.settings?.[e]||"";return e==="script"&&(c=xe(s)),i.createElement(v._,{label:t,labelWidth:16,tooltip:a},i.createElement(M.I,{id:l,placeholder:n,onBlur:d=>r(B({metric:s,settingName:e,newValue:d.target.value})),defaultValue:c}))}const et=(0,V.PH)("@pipelineVariables/add"),Rt=(0,V.PH)("@pipelineVariables/remove"),Bt=(0,V.PH)("@pipelineVariables/rename"),$t=(0,V.PH)("@pipelineVariables/change_metric"),Gs=(t=[],e)=>et.match(e)?[...t,Te(o(t))]:Rt.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):Bt.match(e)?t.map((s,n)=>n!==e.payload.index?s:{...s,name:e.payload.newName}):$t.match(e)?t.map((s,n)=>n!==e.payload.index?s:{...s,pipelineAgg:e.payload.newMetric}):t,Ys=({value:t,previousMetrics:e})=>{const s=j(),n=Ee(a=>s(gt({metric:t,attribute:"pipelineVariables",newValue:a})),t.pipelineVariables,Gs);return(0,i.useEffect)(()=>{t.pipelineVariables?.length||n(et())},[n,t.pipelineVariables?.length]),i.createElement(i.Fragment,null,i.createElement("div",{className:p.css`
          display: flex;
        `},i.createElement(fe.W,{width:16},"Variables"),i.createElement("div",{className:p.css`
            display: grid;
            grid-template-columns: 1fr auto;
            row-gap: 4px;
            margin-bottom: 4px;
          `},t.pipelineVariables.map((a,r)=>i.createElement(i.Fragment,{key:(0,E.uniqueId)("es-bs-")},i.createElement("div",{className:p.css`
                  display: grid;
                  column-gap: 4px;
                  grid-template-columns: auto auto;
                `},i.createElement(M.I,{"aria-label":"Variable name",defaultValue:a.name,placeholder:"Variable Name",onBlur:l=>n(Bt({newName:l.target.value,index:r}))}),i.createElement(jt,{onChange:l=>n($t({newMetric:l.value.id,index:r})),options:e,value:a.pipelineAgg})),i.createElement(At,{index:r,elements:t.pipelineVariables||[],onAdd:()=>n(et()),onRemove:()=>n(Rt(r))}))))),i.createElement(U,{label:"Script",metric:t,settingName:"script",tooltip:"Elasticsearch v5.0 and above: Scripting language is Painless. Use params.<var> to reference a variable. Elasticsearch pre-v5.0: Scripting language is per default Groovy if not changed. For Groovy use <var> to reference a variable.",placeholder:"params.var1 / params.var2"}))},Zs=({metric:t})=>{const e=j(),{current:s}=(0,i.useRef)((0,E.uniqueId)("es-moving-avg-"));return i.createElement(i.Fragment,null,i.createElement(v._,{label:"Model",labelWidth:16},i.createElement(ne.Ph,{inputId:`${s}-model`,onChange:n=>e(B({metric:t,settingName:"model",newValue:n.value})),options:he,value:t.settings?.model})),i.createElement(U,{label:"Window",settingName:"window",metric:t,placeholder:"5"}),i.createElement(U,{label:"Predict",settingName:"predict",metric:t}),(b(t)||y(t)||S(t))&&i.createElement(v._,{label:"Alpha",labelWidth:16},i.createElement(M.I,{id:`${s}-alpha`,onBlur:n=>e(B({metric:t,settingName:"settings",newValue:{...t.settings?.settings,alpha:n.target.value}})),defaultValue:t.settings?.settings?.alpha})),(y(t)||S(t))&&i.createElement(v._,{label:"Beta",labelWidth:16},i.createElement(M.I,{id:`${s}-beta`,onBlur:n=>e(B({metric:t,settingName:"settings",newValue:{...t.settings?.settings,beta:n.target.value}})),defaultValue:t.settings?.settings?.beta})),S(t)&&i.createElement(i.Fragment,null,i.createElement(v._,{label:"Gamma",labelWidth:16},i.createElement(M.I,{id:`${s}-gamma`,onBlur:n=>e(B({metric:t,settingName:"settings",newValue:{...t.settings?.settings,gamma:n.target.value}})),defaultValue:t.settings?.settings?.gamma})),i.createElement(v._,{label:"Period",labelWidth:16},i.createElement(M.I,{id:`${s}-period`,onBlur:n=>e(B({metric:t,settingName:"settings",newValue:{...t.settings?.settings,period:n.target.value}})),defaultValue:t.settings?.settings?.period})),i.createElement(v._,{label:"Pad",labelWidth:16},i.createElement(Oe.x,{id:`${s}-pad`,onChange:n=>e(B({metric:t,settingName:"settings",newValue:{...t.settings?.settings,pad:n.target.checked}})),checked:!!t.settings?.settings?.pad}))),(b(t)||y(t)||S(t))&&i.createElement(v._,{label:"Minimize",labelWidth:16},i.createElement(Oe.x,{id:`${s}-minimize`,onChange:n=>e(B({metric:t,settingName:"minimize",newValue:n.target.checked})),checked:!!t.settings?.minimize})))},Xs=t=>({value:t,label:t}),en=({metric:t})=>{const e=j(),s=Re(["number","date"]),n=Re(t.type);return i.createElement(i.Fragment,null,i.createElement(v._,{label:"Metrics",labelWidth:16},i.createElement(ne.M8,{onChange:a=>e(B({metric:t,settingName:"metrics",newValue:a.map(r=>r.value)})),loadOptions:n,value:t.settings?.metrics?.map(Xs),closeMenuOnSelect:!1,defaultOptions:!0})),i.createElement(v._,{label:"Order",labelWidth:16},i.createElement(ne.Ph,{onChange:a=>e(B({metric:t,settingName:"order",newValue:a.value})),options:Ue,value:t.settings?.order})),i.createElement(v._,{label:"Order By",labelWidth:16,className:p.css`
          & > div {
            width: 100%;
          }
        `},i.createElement(Ye.V,{className:p.css`
            margin-right: 0;
          `,loadOptions:s,onChange:a=>e(B({metric:t,settingName:"orderBy",newValue:a.value})),placeholder:"Select Field",value:t.settings?.orderBy})))},tn=t=>e=>e.value===t,sn=t=>{switch(t.type){case"cardinality":return`Precision threshold: ${t.settings?.precision_threshold||""}`;case"percentiles":return t.settings?.percents&&t.settings?.percents?.length>=1?`Values: ${t.settings?.percents}`:"Percents: Default";case"extended_stats":{const e=Object.entries(t.meta||{}).map(([s,n])=>n&&W.find(tn(s))?.label).filter(Boolean);return`Stats: ${e.length>0?e.join(", "):"None selected"}`}case"raw_document":case"raw_data":return`Size: ${t.settings?.size||500}`;default:return"Options"}},Pe={labelWidth:16},nn=({metric:t,previousMetrics:e})=>{const{current:s}=(0,i.useRef)((0,E.uniqueId)("es-setting-")),n=j(),a=sn(t),r=ye(),l=[{value:"second",label:"Second"},{value:"minute",label:"Minute"},{value:"hour",label:"Hour"},{value:"day",label:"Day"},{value:"week",label:"Week"},{value:"month",label:"Month"},{value:"quarter",label:"Quarter"},{value:"Year",label:"Year"}],u=[{value:"sum",label:"Sum"},{value:"value_count",label:"Value count"}];return i.createElement(Vt,{label:a,hidden:t.hide},t.type==="derivative"&&i.createElement(U,{label:"Unit",metric:t,settingName:"unit"}),t.type==="serial_diff"&&i.createElement(U,{label:"Lag",metric:t,settingName:"lag",placeholder:"1"}),t.type==="cumulative_sum"&&i.createElement(U,{label:"Format",metric:t,settingName:"format"}),t.type==="moving_avg"&&i.createElement(Zs,{metric:t}),t.type==="moving_fn"&&i.createElement(i.Fragment,null,i.createElement(U,{label:"Window",metric:t,settingName:"window"}),i.createElement(U,{label:"Script",metric:t,settingName:"script"}),i.createElement(U,{label:"Shift",metric:t,settingName:"shift"})),t.type==="top_metrics"&&i.createElement(en,{metric:t}),t.type==="bucket_script"&&i.createElement(Ys,{value:t,previousMetrics:e}),(t.type==="raw_data"||t.type==="raw_document")&&i.createElement(v._,{label:"Size",...Pe},i.createElement(M.I,{id:`ES-query-${r.refId}_metric-${t.id}-size`,onBlur:c=>n(B({metric:t,settingName:"size",newValue:c.target.value})),defaultValue:t.settings?.size??C.raw_data.defaults.settings?.size})),t.type==="logs"&&i.createElement(U,{label:"Limit",metric:t,settingName:"limit",placeholder:"500"}),t.type==="cardinality"&&i.createElement(U,{label:"Precision Threshold",metric:t,settingName:"precision_threshold"}),t.type==="extended_stats"&&i.createElement(i.Fragment,null,W.map(c=>i.createElement(an,{key:c.value,stat:c,onChange:d=>n(mt({metric:t,meta:c.value,newValue:d})),value:t.meta?.[c.value]!==void 0?!!t.meta?.[c.value]:!!C.extended_stats.defaults.meta?.[c.value]})),i.createElement(U,{label:"Sigma",metric:t,settingName:"sigma",placeholder:"3"})),t.type==="percentiles"&&i.createElement(v._,{label:"Percentiles",...Pe},i.createElement(M.I,{id:`${s}-percentiles-percents`,onBlur:c=>n(B({metric:t,settingName:"percents",newValue:c.target.value.split(",").filter(Boolean)})),defaultValue:t.settings?.percents||C.percentiles.defaults.settings?.percents,placeholder:"1,5,25,50,75,95,99"})),t.type==="rate"&&i.createElement(i.Fragment,null,i.createElement(v._,{label:"Unit",...Pe,"data-testid":"unit-select"},i.createElement(ne.Ph,{id:`ES-query-${r.refId}_metric-${t.id}-unit`,onChange:c=>n(B({metric:t,settingName:"unit",newValue:c.value})),options:l,value:t.settings?.unit})),i.createElement(v._,{label:"Mode",...Pe,"data-testid":"mode-select"},i.createElement(ne.Ph,{id:`ES-query-${r.refId}_metric-${t.id}-mode`,onChange:c=>n(B({metric:t,settingName:"mode",newValue:c.value})),options:u,value:t.settings?.unit}))),R(t)&&i.createElement(U,{label:"Script",metric:t,settingName:"script",placeholder:"_value * 1"}),P(t)&&i.createElement(U,{label:"Missing",metric:t,settingName:"missing",tooltip:`The missing parameter defines how documents that are missing a value should be treated. By default
            they will be ignored but it is also possible to treat them as if they had a value`}))},an=({stat:t,onChange:e,value:s})=>{const[n]=(0,i.useState)((0,E.uniqueId)("es-field-id-"));return i.createElement(v._,{label:t.label,...Pe,key:t.value},i.createElement(Oe.x,{id:n,onChange:a=>e(a.target.checked),value:s}))},rn=(t,e)=>({color:e&&p.css`
        &,
        &:hover,
        label,
        a {
          color: ${e?t.colors.text.disabled:t.colors.text.primary};
        }
      `}),ln=t=>({label:C[t.type].label,value:t.type}),on=t=>!C[t.type].isPipelineAgg,cn=(t,e,s=!1)=>{const n=t.some(on);return Object.entries(C).filter(([a,{versionRange:r="*"}])=>(0,De.satisfies)(e,r)).filter(([a,r])=>n||!r.isPipelineAgg).filter(([a,r])=>r.xpack?s:!0).map(([a,{label:r}])=>({label:r,value:a}))},un=({value:t})=>{const e=rn((0,re.l4)(),!!t.hide),s=Mt(),n=ye(),a=j(),r=Re(t.type),l=(0,i.useCallback)(async()=>{const c=await r();return R(t)?[{label:"None"},...c]:c},[r,t]),u=n.metrics.slice(0,n.metrics.findIndex(c=>c.id===t.id));return i.createElement(i.Fragment,null,i.createElement(je.m,null,i.createElement(Ge.X,{className:(0,p.cx)(e.color,Fe),options:cn(u,s.esVersion,s.xpack),onChange:c=>a(Ke({id:t.id,type:c.value})),value:ln(t)}),w(t)&&!F(t)&&i.createElement(Ye.V,{className:(0,p.cx)(e.color,Fe),loadOptions:l,onChange:c=>a(He({id:t.id,field:c.value})),placeholder:"Select Field",value:t.field}),F(t)&&!q(t)&&i.createElement(jt,{className:(0,p.cx)(e.color,Fe),onChange:c=>a(He({id:t.id,field:c.value?.id})),options:u,value:t.field})),N(t)&&i.createElement(nn,{metric:t,previousMetrics:u}))},dn=({nextId:t})=>{const e=j(),{metrics:s}=ye(),n=s?.length||0;return i.createElement(i.Fragment,null,s?.map((a,r)=>i.createElement(Ot,{key:`${a.type}-${a.id}`,label:`Metric (${a.id})`,hidden:a.hide,onHideClick:()=>e(dt(a.id)),onRemoveClick:n>1&&(()=>e(ut(a.id)))},i.createElement(un,{value:a}),!C[a.type].isSingleMetric&&r===0&&i.createElement(ke,{iconName:"plus",onClick:()=>e(ct(t)),label:"add"}))))},gn=({query:t,onChange:e,onRunQuery:s,datasource:n,range:a})=>ze(n.esVersion)?i.createElement(fs,{datasource:n,onChange:e,onRunQuery:s,query:t,range:a||(0,K.JK)()},i.createElement(mn,{value:t})):i.createElement(be.b,{title:"Support for Elasticsearch versions after their end-of-life (currently versions < 7.10) was removed"}),Lt=t=>({root:p.css`
    display: flex;
  `,queryFieldWrapper:p.css`
    flex-grow: 1;
    margin: 0 ${t.spacing(.5)} ${t.spacing(.5)} 0;
  `}),Wt=({value:t,onChange:e})=>{const s=(0,re.wW)(Lt);return i.createElement("div",{className:s.queryFieldWrapper},i.createElement(ce.q,{query:t,onBlur:()=>{},onChange:e,placeholder:"Lucene Query",portalOrigin:"elasticsearch"}))},mn=({value:t})=>{const e=j(),s=ys(),n=(0,re.wW)(Lt),a=t?.bucketAggs?.slice(-1)[0]?.type==="date_histogram",r=t.metrics?.every(l=>!C[l.type].isSingleMetric);return i.createElement(i.Fragment,null,i.createElement("div",{className:n.root},i.createElement(fe.W,{width:17},"Query"),i.createElement(Wt,{onChange:l=>e(pt(l)),value:t?.query}),i.createElement(v._,{label:"Alias",labelWidth:15,disabled:!a,tooltip:"Aliasing only works for timeseries queries (when the last group is 'Date Histogram'). For all other query types this field is ignored."},i.createElement(M.I,{id:`ES-query-${t.refId}_alias`,placeholder:"Alias Pattern",onBlur:l=>e(ft(l.currentTarget.value)),defaultValue:t.alias}))),i.createElement(dn,{nextId:s}),r&&i.createElement(qs,{nextId:s}))};var pn=f(37308),fn=f(12006),hn=f(12580),Qt=f(47694),vn=f(89029),yn=f(28151),zt=f(31403),bn=f(54291),En=f(53117),Sn=f(14835),Fn=f(7804),In=f(35919);const{FormField:tt,Switch:wn}=Sn.LegacyForms,Mn=(0,Fn.B)(()=>({firstRow:p.css`
    display: flex;
  `,nameField:p.css`
    flex: 2;
  `,regexField:p.css`
    flex: 3;
  `,row:p.css`
    display: flex;
    align-items: baseline;
  `,urlField:p.css`
    flex: 1;
  `,urlDisplayLabelField:p.css`
    flex: 1;
  `})),Dn=t=>{const{value:e,onChange:s,onDelete:n,suggestions:a,className:r}=t,l=Mn(),[u,c]=xn(e.datasourceUid),d=g=>m=>{s({...e,[g]:m.currentTarget.value})};return i.createElement("div",{className:r},i.createElement("div",{className:l.firstRow+" gf-form"},i.createElement(tt,{className:l.nameField,labelWidth:6,inputWidth:null,label:"Field",type:"text",value:e.field,tooltip:"Can be exact field name or a regex pattern that will match on the field name.",onChange:d("field")}),i.createElement(zt.zx,{variant:"destructive",title:"Remove field",icon:"times",onClick:g=>{g.preventDefault(),n()}})),i.createElement("div",{className:"gf-form"},i.createElement(tt,{label:u?"Query":"URL",labelWidth:6,inputEl:i.createElement(In.v,{placeholder:u?"${__value.raw}":"http://example.com/${__value.raw}",value:e.url||"",onChange:g=>s({...e,url:g}),suggestions:a}),className:l.urlField}),i.createElement(tt,{className:l.urlDisplayLabelField,inputWidth:null,label:"URL Label",type:"text",value:e.urlDisplayLabel,onChange:d("urlDisplayLabel"),tooltip:"Use to override the button label."})),i.createElement("div",{className:l.row},i.createElement(wn,{labelClass:"width-6",label:"Internal link",checked:u,onChange:()=>{u&&s({...e,datasourceUid:void 0}),c(!u)}}),u&&i.createElement(En.q,{tracing:!0,onChange:g=>{s({...e,datasourceUid:g.uid})},current:e.datasourceUid})))};function xn(t){const[e,s]=(0,i.useState)(!!t),n=(0,bn.Z)(t);return(0,i.useEffect)(()=>{!n&&t&&!e&&s(!0),n&&!t&&e&&s(!1)},[n,t,e]),[e,s]}const Cn=t=>({infoText:p.css`
      padding-bottom: ${t.spacing(2)};
      color: ${t.colors.text.secondary};
    `,dataLink:p.css`
      margin-bottom: ${t.spacing(1)};
    `}),On=t=>{const{value:e,onChange:s}=t,n=(0,re.wW)(Cn);return i.createElement(i.Fragment,null,i.createElement("h3",{className:"page-heading"},"Data links"),i.createElement("div",{className:n.infoText},"Add links to existing fields. Links will be shown in log row details next to the field value."),e&&e.length>0&&i.createElement("div",{className:"gf-form-group"},e.map((a,r)=>i.createElement(Dn,{className:n.dataLink,key:r,value:a,onChange:l=>{const u=[...e];u.splice(r,1,l),s(u)},onDelete:()=>{const l=[...e];l.splice(r,1),s(l)},suggestions:[{value:vn.W.valueRaw,label:"Raw value",documentation:"Raw value of the field",origin:yn.L.Value}]}))),i.createElement(zt.zx,{type:"button",variant:"secondary",className:p.css`
          margin-right: 10px;
        `,icon:"plus",onClick:a=>{a.preventDefault();const r=[...e||[],{field:"",url:""}];s(r)}},"Add"))};var Pn=f(49922),Ht=f(13393);const st=[{label:"No pattern",value:"none"},{label:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{label:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{label:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{label:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{label:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],Kt=[{label:"7.10+",value:"7.10.0"},{label:"8.x",value:"8.0.0"}],Vn=({value:t,onChange:e})=>{const s=Kt.find(a=>a.value===t.jsonData.esVersion),n=!s&&(0,De.valid)(t.jsonData.esVersion)?{label:t.jsonData.esVersion,value:t.jsonData.esVersion}:void 0;return i.createElement(i.Fragment,null,i.createElement(Ht.C,{label:"Elasticsearch details"},i.createElement(v._,{label:"Index name",labelWidth:26},i.createElement(M.I,{id:"es_config_indexName",value:t.database||"",onChange:Nn("database",t,e),width:24,placeholder:"es-index-name",required:!0})),i.createElement(v._,{label:"Pattern",labelWidth:26},i.createElement(ne.Ph,{inputId:"es_config_indexPattern",value:st.find(a=>a.value===(t.jsonData.interval===void 0?"none":t.jsonData.interval)),options:st,onChange:An(t,e),width:24})),i.createElement(v._,{label:"Time field name",labelWidth:26},i.createElement(M.I,{id:"es_config_timeField",value:t.jsonData.timeField||"",onChange:nt("timeField",t,e),width:24,placeholder:"@timestamp",required:!0})),i.createElement(v._,{label:"ElasticSearch version",labelWidth:26},i.createElement(ne.Ph,{inputId:"es_config_version",options:[n,...Kt].filter(Pn.fQ),onChange:a=>{const r=_n(t.jsonData.maxConcurrentShardRequests);e({...t,jsonData:{...t.jsonData,esVersion:a.value,maxConcurrentShardRequests:r}})},value:s||n,width:24})),i.createElement(v._,{label:"Max concurrent Shard Requests",labelWidth:26},i.createElement(M.I,{id:"es_config_shardRequests",value:t.jsonData.maxConcurrentShardRequests||"",onChange:nt("maxConcurrentShardRequests",t,e),width:24})),i.createElement(v._,{label:"Min time interval",labelWidth:26,tooltip:i.createElement(i.Fragment,null,"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example"," ",i.createElement("code",null,"1m")," if your data is written every minute."),error:"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s",invalid:!!t.jsonData.timeInterval&&!/^\d+(ms|[Mwdhmsy])$/.test(t.jsonData.timeInterval)},i.createElement(M.I,{id:"es_config_minTimeInterval",value:t.jsonData.timeInterval||"",onChange:nt("timeInterval",t,e),width:24,placeholder:"10s"})),i.createElement(v._,{label:"X-Pack enabled",labelWidth:26},i.createElement(Oe.x,{id:"es_config_xpackEnabled",value:t.jsonData.xpack||!1,onChange:qt("xpack",t,e)})),t.jsonData.xpack&&i.createElement(v._,{label:"Include Frozen Indices",labelWidth:26},i.createElement(Oe.x,{id:"es_config_frozenIndices",value:t.jsonData.includeFrozen??!1,onChange:qt("includeFrozen",t,e)}))))},Nn=(t,e,s)=>n=>{s({...e,[t]:n.currentTarget.value})},nt=(t,e,s)=>n=>{s({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.value}})},qt=(t,e,s)=>n=>{s({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.checked}})},An=(t,e)=>s=>{const{database:n}=t,a=s.value==="none"?void 0:s.value;if(!n||n.length===0||n.startsWith("[logstash-]")){let r="";if(a!==void 0){const l=st.find(u=>u.value===a);l&&(r=l.example??"")}e({...t,database:r,jsonData:{...t.jsonData,interval:a}})}else e({...t,jsonData:{...t.jsonData,interval:a}})};function _n(t){return t===256?5:t||Ut()}function Ut(){return 5}const Tn=t=>{const{value:e,onChange:s}=t,n=a=>r=>{s({...e,[a]:r.currentTarget.value})};return i.createElement(Ht.C,{label:"Logs"},i.createElement(v._,{label:"Message field name",labelWidth:22},i.createElement(M.I,{id:"es_logs-config_logMessageField",value:e.logMessageField,onChange:n("logMessageField"),placeholder:"_source",width:24})),i.createElement(v._,{label:"Level field name",labelWidth:22},i.createElement(M.I,{id:"es_logs-config_logLevelField",value:e.logLevelField,onChange:n("logLevelField"),width:24})))},Jt=t=>{const e=ot(t.jsonData.esVersion);return{...t,jsonData:{...t.jsonData,timeField:t.jsonData.timeField||"@timestamp",esVersion:e,maxConcurrentShardRequests:t.jsonData.maxConcurrentShardRequests||Ut(),logMessageField:t.jsonData.logMessageField||"",logLevelField:t.jsonData.logLevelField||"",includeFrozen:t.jsonData.includeFrozen??!1}}},kn=t=>!!(0,De.valid)(t.jsonData.esVersion)&&!!t.jsonData.timeField&&!!t.jsonData.maxConcurrentShardRequests&&t.jsonData.logMessageField!==void 0&&t.jsonData.logLevelField!==void 0,jn=t=>{const e=(0,i.useRef)(t.options.access==="direct"),{options:s,onOptionsChange:n}=t,a=Jt(s);(0,i.useEffect)(()=>{kn(s)||n(Jt(s))},[]);const r=ze(a.jsonData.esVersion);return i.createElement(i.Fragment,null,a.access==="direct"&&i.createElement(be.b,{title:"Error",severity:"error"},"Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode."),!r&&i.createElement(be.b,{title:"Deprecation notice",severity:"error"},"Support for Elasticsearch versions after their end-of-life (currently versions < 7.10) was removed"),i.createElement(fn.E,{defaultUrl:"http://localhost:9200",dataSourceConfig:a,showAccessOptions:e.current,onChange:n,sigV4AuthToggleEnabled:Qt.vc.sigV4AuthEnabled,renderSigV4Editor:i.createElement(pn.SIGV4ConnectionConfig,{...t})}),Qt.vc.featureToggles.secureSocksDatasourceProxy&&i.createElement(hn.i,{options:a,onOptionsChange:n}),i.createElement(Vn,{value:a,onChange:n}),i.createElement(Tn,{value:a.jsonData,onChange:l=>n({...a,jsonData:l})}),i.createElement(On,{value:a.jsonData.dataLinks,onChange:l=>{n({...a,jsonData:{...a.jsonData,dataLinks:l}})}}))};var Be=f(37537),Rn=f(71673),Ie=f(53786),we=f(2101),at=f(94514),Gt=f(98356),Bn=f(68193),$n=f(80136),Ln=f(43464),Yt=f(29236),oe=f(46519),Ve=f(90595),it=f(40400),Wn=f(22069),Qn=f(54899),Zt=f(35645),zn=f(86647),Hn=f(37959),Kn=f(19349),qn=f(98639),Un=f(81042),rt=f(16911),Jn=f(38685),Me=f(14582),Xt=f(37219),Gn=f(40229);const es=`${se.pre}([^@]+)${se.post}`;class ts{constructor(e,s){this.targets=e,this.response=s,this.processResponseToSeries=()=>{const n=[];for(let a=0;a<this.response.responses.length;a++){const r=this.response.responses[a],l=this.targets[a];if(r.error)throw this.getErrorFromElasticResponse(this.response,r.error);if(r.hits&&r.hits.hits.length>0&&this.processHits(r.hits,n,l),r.aggregations){const u=r.aggregations,c=this.targets[a],d=[],g=new Xt.Z;g.refId=c.refId,this.processBuckets(u,c,d,g,{},0),this.trimDatapoints(d,c),this.nameSeries(d,c);for(let m=0;m<d.length;m++)n.push(d[m]);g.rows.length>0&&n.push(g)}}return{data:n}},this.targets=e,this.response=s}processMetrics(e,s,n,a){let r;for(let l=0;l<s.metrics.length;l++){const u=s.metrics[l];if(!u.hide)switch(u.type){case"count":{r={datapoints:[],metric:"count",props:a,refId:s.refId};for(let c=0;c<e.buckets.length;c++){const d=e.buckets[c],g=d.doc_count;r.datapoints.push([g,d.key])}n.push(r);break}case"percentiles":{if(e.buckets.length===0)break;const d=e.buckets[0][u.id].values;for(const g in d){r={datapoints:[],metric:"p"+g,props:a,field:u.field,refId:s.refId};for(let m=0;m<e.buckets.length;m++){const h=e.buckets[m],x=h[u.id].values;r.datapoints.push([x[g],h.key])}n.push(r)}break}case"extended_stats":{for(const c in u.meta)if(u.meta[c]){r={datapoints:[],metric:c,props:a,field:u.field,refId:s.refId};for(let d=0;d<e.buckets.length;d++){const g=e.buckets[d],m=g[u.id];m.std_deviation_bounds_upper=m.std_deviation_bounds.upper,m.std_deviation_bounds_lower=m.std_deviation_bounds.lower,r.datapoints.push([m[c],g.key])}n.push(r)}break}case"top_metrics":{if(u.settings?.metrics?.length)for(const c of u.settings?.metrics){r={datapoints:[],metric:u.type,props:a,refId:s.refId,field:c};for(let d=0;d<e.buckets.length;d++){const g=e.buckets[d],h=g[u.id].top.map(z=>z.metrics[c]?z.metrics[c]:null),x=[h[h.length-1],g.key];r.datapoints.push(x)}n.push(r)}break}default:{r={datapoints:[],metric:u.type,metricId:u.id,props:a,refId:s.refId},w(u)&&(r.field=u.field);for(let c=0;c<e.buckets.length;c++){const d=e.buckets[c],g=d[u.id];g!==void 0&&(g.normalized_value?r.datapoints.push([g.normalized_value,d.key]):r.datapoints.push([g.value,d.key]))}n.push(r);break}}}}processAggregationDocs(e,s,n,a,r){if(a.columns.length===0){for(const c of(0,E.keys)(r))a.addColumn({text:c,filterable:!0});a.addColumn({text:s.field,filterable:!0})}const l=(c,d,g)=>{a.addColumn({text:d}),c.push(g)},u=(0,E.isArray)(e.buckets)?e.buckets:[e.buckets];for(const c of u){const d=[];for(const g of(0,E.values)(r))d.push(g);d.push(c.key);for(const g of n.metrics||[])switch(g.type){case"count":{l(d,this.getMetricName(g.type),c.doc_count);break}case"extended_stats":{for(const m in g.meta){if(!g.meta[m])continue;const h=c[g.id];h.std_deviation_bounds_upper=h.std_deviation_bounds.upper,h.std_deviation_bounds_lower=h.std_deviation_bounds.lower,l(d,this.getMetricName(m),h[m])}break}case"percentiles":{const m=c[g.id].values;for(const h in m)l(d,`p${h} ${g.field}`,m[h]);break}case"top_metrics":{const m=this.getMetricName(g.type);if(g.settings?.metrics)for(const h of g.settings.metrics){const x=g.settings.metrics.length>1?`${m} ${h}`:m,z=c[g.id];l(d,x,z.top[0].metrics[h])}break}default:{let m=this.getMetricName(g.type);(0,E.filter)(n.metrics,{type:g.type}).length>1&&(w(g)&&(m+=" "+g.field),g.type==="bucket_script"&&(m=xe(g))),l(d,m,c[g.id].value);break}}a.rows.push(d)}}processBuckets(e,s,n,a,r,l){let u,c,d,g;const m=s.bucketAggs.length-1;for(g in e)if(c=(0,E.find)(s.bucketAggs,{id:g}),d=e[g],!!c){if(c.type==="nested"){this.processBuckets(d,s,n,a,r,l+1);continue}if(l===m)c.type==="date_histogram"?this.processMetrics(d,s,n,r):this.processAggregationDocs(d,c,s,a,r);else for(const h in d.buckets)u=d.buckets[h],r=(0,E.clone)(r),u.key!==void 0?r[c.field]=u.key:r.filter=h,u.key_as_string&&(r[c.field]=u.key_as_string),this.processBuckets(u,s,n,a,r,l+1)}}getMetricName(e){const s=Object.entries(C).filter(([a])=>a===e).map(([a,r])=>r)[0];if(s)return s.label;const n=W.find(a=>a.value===e);return n?n.label:e}getSeriesName(e,s,n){let a=this.getMetricName(e.metric);if(s.alias){const u=/\{\{([\s\S]+?)\}\}/g;return s.alias.replace(u,(c,d,g)=>{const m=d||g;return m.indexOf("term ")===0?e.props[m.substring(5)]:e.props[m]!==void 0?e.props[m]:m==="metric"?a:m==="field"?e.field||"":c})}if(os(e.metric))if(e.metric&&cs(e.metric)){const u=(0,E.find)(s.metrics,{id:e.metricId});if(u&&u.settings.script){a=xe(u);for(const c of u.pipelineVariables){const d=(0,E.find)(s.metrics,{id:c.pipelineAgg});d&&(a=a.replace("params."+c.name,ve(d)))}}else a="Unset"}else{const u=(0,E.find)(s.metrics,{id:e.field});u?a+=" "+ve(u):a="Unset"}else e.field&&(a+=" "+e.field);if((0,E.keys)(e.props).length===0)return a;let l="";for(const u in e.props)l+=e.props[u]+" ";return n?l.trim()+" "+a:l.trim()}nameSeries(e,s){const n=(0,E.uniq)((0,E.map)(e,"metric")).length,a=(s.metrics?.filter(r=>r.type==="top_metrics")).some(r=>(r?.settings?.metrics?.length||0)>1);for(let r=0;r<e.length;r++){const l=e[r];l.target=this.getSeriesName(l,s,n>1||a)}}processHits(e,s,n){const a=typeof e.total=="number"?e.total:e.total.value,r={target:n.refId,type:"docs",refId:n.refId,datapoints:[],total:a,filterable:!0};let l,u,c,d;for(d=0;d<e.hits.length;d++){if(u=e.hits[d],c={_id:u._id,_type:u._type,_index:u._index,sort:u.sort,highlight:u.highlight},u._source)for(l in u._source)c[l]=u._source[l];for(l in u.fields)c[l]=u.fields[l];r.datapoints.push(c)}s.push(r)}trimDatapoints(e,s){const n=(0,E.find)(s.bucketAggs,{type:"date_histogram"});if(n&&n.settings&&n.settings.trimEdges){const r=n.settings.trimEdges;for(const l in e){const u=e[l];u.datapoints.length>r*2&&(u.datapoints=u.datapoints.slice(r,u.datapoints.length-r))}}}getErrorFromElasticResponse(e,s){const n={};return n.data=JSON.stringify(s,null,4),s.root_cause&&s.root_cause.length>0&&s.root_cause[0].reason?n.message=s.root_cause[0].reason:n.message=s.reason||"Unknown elastic error response",e.$$config&&(n.config=e.$$config),n}getTimeSeries(){if(this.targets.some(s=>We(s,"raw_data")))return this.processResponseToDataFrames(!1);const e=this.processResponseToSeries();return{...e,data:e.data.map(s=>(0,rt.g0)(s))}}getLogs(e,s){return this.processResponseToDataFrames(!0,e,s)}processResponseToDataFrames(e,s,n){const a=[];for(let r=0;r<this.response.responses.length;r++){const l=this.response.responses[r];if(l.error)throw this.getErrorFromElasticResponse(this.response,l.error);if(l.hits){const{propNames:u,docs:c}=Yn(l.hits.hits),d=c.length?ss(u.map(Zn(c)),e,this.targets[0].timeField,s,n):ss([],e);e&&ns(d,"logs");for(const m of c){if(n&&(m.level=m[n]),m.highlight){const h=new RegExp(es,"g"),x=new RegExp(es),z=Object.keys(m.highlight).flatMap(me=>m.highlight[me].flatMap(X=>{const $=X.match(h);return $?$.map(ee=>{const H=ee.match(x);return H&&H[1]||null}):[]})).filter(E.identity),G=d.meta?.searchWords?(0,E.uniq)([...d.meta.searchWords,...z]):[...z];d.meta=d.meta?{...d.meta,searchWords:G}:{searchWords:G}}d.add(m)}const g=this.targets[r];d.refId=g.refId,a.push(d)}if(l.aggregations){const u=l.aggregations,c=this.targets[r],d=[],g=new Xt.Z;if(this.processBuckets(u,c,d,g,{},0),this.trimDatapoints(d,c),this.nameSeries(d,c),g.rows.length>0){const m=(0,rt.g0)(g);m.refId=c.refId,a.push(m)}for(let m=0;m<d.length;m++){let h=(0,rt.g0)(d[m]);e&&ns(h,"graph"),h.refId=c.refId,a.push(h)}}}return{data:a}}}const Yn=t=>{const e=[];let s=[];for(const n of t){const a=n._source?(0,Gn.default)(n._source):{},r={_id:n._id,_type:n._type,_index:n._index,sort:n.sort,highlight:n.highlight,_source:{...a},...a};for(const l of Object.keys(r))s.indexOf(l)===-1&&s.push(l);e.push(r)}return s.sort(),{docs:e,propNames:s}},ss=(t,e,s,n,a)=>{const r=new Jn.v({fields:[]});if(s&&r.addField({config:{filterable:!0},name:s,type:Me.fS.time}),n){const u=r.addField({name:n,type:Me.fS.string});r.setParser(u,c=>c||"")}if(a){const u=r.addField({name:"level",type:Me.fS.string});r.setParser(u,c=>c||"")}const l=r.fields.map(u=>u.name);for(const[u,c]of t){if(l.includes(u)||!e&&u==="_source")continue;const d=r.addField({config:{filterable:!0},name:u,type:c});r.setParser(d,g=>g||"")}return r},ns=(t,e)=>{let s=t;s.meta?s.meta.preferredVisualisationType=e:s.meta={preferredVisualisationType:e}},Zn=t=>e=>[e,Xn(t.find(s=>s[e]!==void 0)?.[e])],Xn=t=>{switch(typeof t){case"number":return Me.fS.number;case"string":return Me.fS.string;default:return Me.fS.other}},ea={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}};class ta{constructor(e,s){this.pattern=e,this.interval=s,this.dateLocale="en"}getIndexForToday(){return this.interval?(0,oe.zh)().locale(this.dateLocale).format(this.pattern):this.pattern}getIndexList(e,s){if(!this.interval)return this.pattern;const a=ea[this.interval],r=(0,oe.CQ)(e||(0,oe.CQ)(s).add(-7,a.amount)).utc().startOf(a.startOf),l=(0,oe.CQ)(s||(0,oe.CQ)(e).add(7,a.amount)).utc().startOf(a.startOf).valueOf(),u=[];for(;r.valueOf()<=l;)u.push(r.locale(this.dateLocale).format(this.pattern)),r.add(1,a.amount);return u}}var $e=f(62163);class sa extends L.iL{constructor(e,s){super(),this.datasource=e,Object.assign(this,s)}importFromAbstractQuery(e){return{metrics:[{id:"1",type:"logs"}],query:this.getElasticsearchQuery(e.labelMatchers),refId:e.refId}}getElasticsearchQuery(e){return e.map(s=>{switch(s.operator){case $e.K2.Equal:return s.name+':"'+s.value+'"';case $e.K2.NotEqual:return"-"+s.name+':"'+s.value+'"';case $e.K2.EqualRegEx:return s.name+":/"+s.value+"/";case $e.K2.NotEqualRegEx:return"-"+s.name+":/"+s.value+"/"}}).join(" AND ")}}class na{constructor(e){this.timeField=e.timeField}getRangeFilter(){const e={};return e[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},e}buildTermsAgg(e,s,n){if(s.terms={field:e.field},!e.settings)return s;const a=e.settings?.size?parseInt(e.settings.size,10):500;if(s.terms.size=a===0?500:a,e.settings.orderBy!==void 0){s.terms.order={},e.settings.orderBy==="_term"?s.terms.order._key=e.settings.order:s.terms.order[e.settings.orderBy]=e.settings.order;const r=lt(e.settings.orderBy);if(r){for(let l of n.metrics||[])if(l.id===r){l.type==="count"?s.terms.order={_count:e.settings.order}:w(l)&&(s.aggs={},s.aggs[l.id]={[l.type]:{field:l.field}});break}}}return e.settings.min_doc_count!==void 0&&(s.terms.min_doc_count=parseInt(e.settings.min_doc_count,10),isNaN(s.terms.min_doc_count)&&(s.terms.min_doc_count=e.settings.min_doc_count)),e.settings.missing&&(s.terms.missing=e.settings.missing),s}getDateHistogramAgg(e){const s={},n=e.settings||{};s.field=e.field||this.timeField,s.min_doc_count=n.min_doc_count||0,s.extended_bounds={min:"$timeFrom",max:"$timeTo"},s.format="epoch_millis",n.timeZone&&n.timeZone!==qe.RQ.utc&&(s.time_zone=n.timeZone),n.offset!==""&&(s.offset=n.offset);const a=n.interval==="auto"?"${__interval_ms}ms":n.interval;return s.fixed_interval=a,s}getHistogramAgg(e){const s={},n=e.settings||{};return s.interval=n.interval,s.field=e.field,s.min_doc_count=n.min_doc_count||0,s}getFiltersAgg(e){const s={};for(let{query:n,label:a}of e.settings?.filters||[])s[a||n]={query_string:{query:n,analyze_wildcard:!0}};return s}documentQuery(e,s){return e.size=s,e.sort=[{[this.timeField]:{order:"desc",unmapped_type:"boolean"}},{_doc:{order:"desc"}}],e.script_fields={},e}addAdhocFilters(e,s){if(!s)return;let n,a,r,l;for(n=0;n<s.length;n++)switch(a=s[n],r={},r[a.key]=a.value,l={},l[a.key]={query:a.value},a.operator){case"=":e.query.bool.must||(e.query.bool.must=[]),e.query.bool.must.push({match_phrase:l});break;case"!=":e.query.bool.must_not||(e.query.bool.must_not=[]),e.query.bool.must_not.push({match_phrase:l});break;case"<":r[a.key]={lt:a.value},e.query.bool.filter.push({range:r});break;case">":r[a.key]={gt:a.value},e.query.bool.filter.push({range:r});break;case"=~":e.query.bool.filter.push({regexp:r});break;case"!~":e.query.bool.filter.push({bool:{must_not:{regexp:r}}});break}}build(e,s){e.metrics=e.metrics||[Se()],e.bucketAggs=e.bucketAggs||[de()],e.timeField=this.timeField;let n,a,r,l,u;const c={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};if(e.query&&e.query!==""&&(c.query.bool.filter=[...c.query.bool.filter,{query_string:{analyze_wildcard:!0,query:e.query}}]),this.addAdhocFilters(c,s),e.bucketAggs.length===0&&(n=e.metrics[0],!n||!(n.type==="raw_document"||n.type==="raw_data")))throw{message:"Invalid query"};if(e.metrics?.[0]?.type==="raw_document"||e.metrics?.[0]?.type==="raw_data"){n=e.metrics[0];const d=n.settings?.size?parseInt(n.settings.size,10):500;return this.documentQuery(c,d||500)}for(u=c,a=0;a<e.bucketAggs.length;a++){const d=e.bucketAggs[a],g={};switch(d.type){case"date_histogram":{g.date_histogram=this.getDateHistogramAgg(d);break}case"histogram":{g.histogram=this.getHistogramAgg(d);break}case"filters":{g.filters={filters:this.getFiltersAgg(d)};break}case"terms":{this.buildTermsAgg(d,g,e);break}case"geohash_grid":{g.geohash_grid={field:d.field,precision:d.settings?.precision};break}case"nested":{g.nested={path:d.field};break}}u.aggs=u.aggs||{},u.aggs[d.id]=g,u=g}for(u.aggs={},a=0;a<e.metrics.length;a++){if(n=e.metrics[a],n.type==="count")continue;const d={};let g={};if(F(n))if(q(n))if(n.pipelineVariables){for(g={buckets_path:{}},r=0;r<n.pipelineVariables.length;r++)if(l=n.pipelineVariables[r],l.name&&l.pipelineAgg&&/^\d*$/.test(l.pipelineAgg)){const m=k(e.metrics,l.pipelineAgg);m&&(m.type==="count"?g.buckets_path[l.name]="_count":g.buckets_path[l.name]=l.pipelineAgg)}}else continue;else if(n.field&&/^\d*$/.test(n.field)){const m=k(e.metrics,n.field);m&&(m.type==="count"?g={buckets_path:"_count"}:g={buckets_path:n.field})}else continue;else w(n)&&(g={field:n.field});if(N(n))switch(Object.entries(n.settings||{}).filter(([m,h])=>h!==null).forEach(([m,h])=>{g[m]=m==="script"?this.buildScript(xe(n)):h}),n.type){case"moving_avg":g={...g,...g?.window!==void 0&&{window:this.toNumber(g.window)},...g?.predict!==void 0&&{predict:this.toNumber(g.predict)},...D(n)&&{settings:{...g.settings,...Object.fromEntries(Object.entries(g.settings||{}).filter(([m])=>["alpha","beta","gamma","period"].includes(m)).filter(([m,h])=>h!==void 0).map(([m,h])=>[m,this.toNumber(h)]))}}};break;case"serial_diff":g={...g,...g.lag!==void 0&&{lag:this.toNumber(g.lag)}};break;case"top_metrics":g={metrics:n.settings?.metrics?.map(m=>({field:m})),size:1},n.settings?.orderBy&&(g.sort=[{[n.settings?.orderBy]:n.settings?.order}]);break}d[n.type]=g,u.aggs[n.id]=d}return c}buildScript(e){return e}toNumber(e){const s=parseFloat(`${e}`);return isNaN(s)?e:s}getTermsQuery(e){const s={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&s.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});let n=500;e.size&&(n=e.size),s.aggs={1:{terms:{field:e.field,size:n,order:{}}}};const{orderBy:a="key",order:r=a==="doc_count"?"desc":"asc"}=e;if(["asc","desc"].indexOf(r)<0)throw{message:`Invalid query sort order ${r}`};switch(a){case"key":case"term":const l="_key";s.aggs[1].terms.order[l]=r;break;case"doc_count":s.aggs[1].terms.order._count=r;break;default:throw{message:`Invalid query sort type ${a}`}}return s}getLogsQuery(e,s,n){let a={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};return this.addAdhocFilters(a,n),e.query&&a.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}}),a=this.documentQuery(a,s),{...a,aggs:this.build(e).aggs,highlight:{fields:{"*":{}},pre_tags:[se.pre],post_tags:[se.post],fragment_size:2147483647}}}}var Ne=f(26418);function aa(t){const e=t.annotation,s=t.onAnnotationChange;return i.createElement(i.Fragment,null,i.createElement("div",{className:"gf-form-group"},i.createElement(Wt,{value:e.target?.query,onChange:n=>{s({...e,query:n})}})),i.createElement("div",{className:"gf-form-group"},i.createElement("h6",null,"Field mappings"),i.createElement(Ne.EditorRow,null,i.createElement(Ne.EditorField,{label:"Time"},i.createElement(M.I,{type:"text",placeholder:"@timestamp",value:e.timeField,onChange:n=>{s({...e,timeField:n.currentTarget.value})}})),i.createElement(Ne.EditorField,{label:"Time End"},i.createElement(M.I,{type:"text",value:e.timeEndField,onChange:n=>{s({...e,timeEndField:n.currentTarget.value})}})),i.createElement(Ne.EditorField,{label:"Text"},i.createElement(M.I,{type:"text",value:e.textField,onChange:n=>{s({...e,textField:n.currentTarget.value})}})),i.createElement(Ne.EditorField,{label:"Tags"},i.createElement(M.I,{type:"text",placeholder:"tags",value:e.tagsField,onChange:n=>{s({...e,tagsField:n.currentTarget.value})}})))))}var as=f(41818),ia=f(92624),ra=f(31886);const la=({payload:{dashboardId:t,orgId:e,grafanaVersion:s,queries:n}})=>{try{const a=n[ra.id].filter(x=>!x.hide);if(!a?.length)return;const r=a.filter(ca),l=a.filter(x=>!!x.query),u=a.filter(x=>Ae(x)==="logs"),c=a.filter(x=>Ae(x)==="metric"),d=a.filter(x=>Ae(x)==="raw_data"),g=a.filter(x=>Ae(x)==="raw_document"),m=a.filter(oa),h={grafana_version:s,dashboard_id:t,org_id:e,queries_count:a.length,logs_queries_count:u.length,metric_queries_count:c.length,raw_data_queries_count:d.length,raw_document_queries_count:g.length,queries_with_template_variables_count:r.length,queries_with_changed_line_limit_count:m.length,queries_with_lucene_query_count:l.length};(0,as.ff)("grafana_elasticsearch_dashboard_loaded",h)}catch(a){console.error("error in elasticsearch tracking handler",a)}},Ae=t=>!t.metrics||!t.metrics.length?void 0:["logs","raw_data","raw_document"].includes(t.metrics[0].type)?t.metrics[0].type:"metric",is=t=>{if(t.metrics?.[0]?.type!=="logs")return;const e=t.metrics?.[0].settings?.limit;return e?parseInt(e,10):void 0},oa=t=>{const e=is(t);return e!==void 0&&e!==500},ca=t=>ia.J7.test(t.query??""),ua=t=>!!t.startsWith(ls);function rs(t,e,s){const{targets:n,app:a}=e;if(!(a===it.zj.Dashboard||a===it.zj.PanelViewer))for(const r of n){if(ua(r.refId))return;(0,as.ff)("grafana_elasticsearch_query_executed",{app:a,grafana_version:Zt.v.buildInfo.version,with_lucene_query:!!r.query,query_type:Ae(r),line_limit:is(r),alias:r.alias,has_error:t.error!==void 0,has_data:t.data.some(l=>l.length>0),simultaneously_sent_query_count:n.length,time_range_from:e?.range?.from?.toISOString(),time_range_to:e?.range?.to?.toISOString(),time_taken:Date.now()-s.getTime()})}}const ls="log-volume-",da=["_index","_type","_id","_source","_size","_field_names","_ignored","_routing","_meta"];class ga extends Wn.CK{constructor(e,s=(0,qn.J)()){super(e),this.templateSrv=s,this.getLogRowContext=async(a,r)=>{const u=a.dataFrame.fields.find(ae=>ae.name==="sort")?.values.get(a.rowIndex)||[a.timeEpochMs],c=r?.direction==="FORWARD"?"asc":"desc",d=r?.direction==="FORWARD"?this.getQueryHeader("query_then_fetch",(0,oe.CQ)(a.timeEpochMs)):this.getQueryHeader("query_then_fetch",void 0,(0,oe.CQ)(a.timeEpochMs)),g=r?.limit??10,m=JSON.stringify({size:g,query:{bool:{filter:[{range:{[this.timeField]:{[r?.direction==="FORWARD"?"gte":"lte"]:a.timeEpochMs,format:"epoch_millis"}}}]}},sort:[{[this.timeField]:c},{_doc:c}],search_after:u}),h=[d,m].join(`
`)+`
`,x=this.getMultiSearchUrl(),z=await(0,ge.n)(this.post(x,h)),G=[{refId:`${a.dataFrame.refId}`,metrics:[{type:"logs",id:"1"}]}],X=new ts(G,fa(z,c)).getLogs(this.logMessageField,this.logLevelField),$=(0,E.first)(X.data);if(!$)return{data:[]};const ee=$.fields.find(ae=>ae.name===this.timeField),H=$.fields.find(ae=>ae.name===this.logMessageField);return ee&&H?{data:[{...$,fields:[...$.fields,{...ee,name:"ts"},{...H,name:"line"}]}]}:X},this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.url=e.url,this.name=e.name,this.index=e.database??"",this.isProxyAccess=e.access==="proxy";const n=e.jsonData||{};this.timeField=n.timeField,this.esVersion=ot(n.esVersion),this.xpack=Boolean(n.xpack),this.indexPattern=new ta(this.index,n.interval),this.interval=n.timeInterval,this.maxConcurrentShardRequests=n.maxConcurrentShardRequests,this.queryBuilder=new na({timeField:this.timeField}),this.logMessageField=n.logMessageField||"",this.logLevelField=n.logLevelField||"",this.dataLinks=n.dataLinks||[],this.includeFrozen=n.includeFrozen??!1,this.annotations={QueryEditor:aa},this.logMessageField===""&&(this.logMessageField=void 0),this.logLevelField===""&&(this.logLevelField=void 0),this.languageProvider=new sa(this),this.timeSrv=(0,Kn.$t)()}request(e,s,n,a){if(!this.isProxyAccess){const l=new Error("Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode.");return(0,Be._)(()=>l)}if(!ze(this.esVersion)){const l=new Error("Support for Elasticsearch versions after their end-of-life (currently versions < 7.10) was removed.");return(0,Be._)(()=>l)}const r={url:this.url+"/"+s,method:e,data:n,headers:a};return(this.basicAuth||this.withCredentials)&&(r.withCredentials=!0),this.basicAuth&&(r.headers={Authorization:this.basicAuth}),(0,Qn.i)().fetch(r).pipe((0,we.U)(l=>(l.data.$$config=l.config,l.data)),(0,at.K)(l=>{if(l.data){const u=l.data.error?.reason??l.data.message??"Unknown error";return(0,Be._)({message:"Elasticsearch error: "+u,error:l.data.error})}return(0,Be._)(l)}))}async importFromAbstractQueries(e){return e.map(s=>this.languageProvider.importFromAbstractQuery(s))}get(e,s=(0,K.JK)()){let n=this.indexPattern.getIndexList(s.from,s.to);Array.isArray(n)||(n=[this.indexPattern.getIndexForToday()]);const a=n.map(r=>r+e);return this.requestAllIndices(a)}requestAllIndices(e){const n=e.length;return(0,Rn.R)({initialState:0,condition:a=>a<Math.min(n,7),iterate:a=>a+1}).pipe((0,Gt.z)(a=>this.request("GET",e[n-a-1]).pipe((0,at.K)(r=>(0,Ie.of)({err:r})))),(0,Bn.n)(a=>a?.err?.status===404),(0,$n.T)(()=>"Could not find an available index for this time range."),(0,Ln.P)(),(0,we.U)(a=>{if(a.err)throw a.err;return a}))}post(e,s){return this.request("POST",e,s,{"Content-Type":"application/x-ndjson"})}annotationQuery(e){const s=e.annotation,n=s.timeField||"@timestamp",a=s.timeEndField||null,r=s.query,l=s.tagsField||"tags",u=s.textField||null,c=[],d={};if(d[n]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},c.push({range:d}),a){const G={};G[a]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},c.push({range:G})}const g=this.interpolateLuceneQuery(r),m={bool:{filter:[{bool:{should:c,minimum_should_match:1}}]}};g&&m.bool.filter.push({query_string:{query:g}});const h={query:m,size:1e4},x={search_type:"query_then_fetch",ignore_unavailable:!0};s.index?x.index=s.index:x.index=this.indexPattern.getIndexList(e.range.from,e.range.to);const z=JSON.stringify(x)+`
`+JSON.stringify(h)+`
`;return(0,ge.n)(this.post("_msearch",z).pipe((0,we.U)(G=>{const me=[],X=G.responses[0].hits.hits,$=(ee,H)=>{if(!H)return;const ae=H.split(".");let te=ee;for(let Y=0;Y<ae.length;Y++)if(te=te[ae[Y]],!te)return console.log("could not find field in annotation: ",H),"";return te};for(let ee=0;ee<X.length;ee++){const H=X[ee]._source;let ae=$(H,n);if(typeof X[ee].fields<"u"){const Y=X[ee].fields;((0,E.isString)(Y[n])||(0,E.isNumber)(Y[n]))&&(ae=Y[n])}const te={annotation:s,time:(0,oe.zh)(ae).valueOf(),text:$(H,u),tags:$(H,l)};if(a){const Y=$(H,a);Y&&(te.timeEnd=(0,oe.zh)(Y).valueOf())}if(s.titleField){const Y=$(H,s.titleField);Y&&(te.text=Y+`
`+te.text)}typeof te.tags=="string"&&(te.tags=te.tags.split(",")),me.push(te)}return me})))}interpolateLuceneQuery(e,s){return this.templateSrv.replace(e,s,"lucene")}interpolateVariablesInQueries(e,s){const n=l=>l.type==="filters"?{...l,settings:{...l.settings,filters:l.settings?.filters?.map(u=>({...u,query:this.interpolateLuceneQuery(u.query,s)||"*"}))}}:l,a=e.map(l=>({...l,datasource:this.getRef(),query:this.addAdHocFilters(this.interpolateLuceneQuery(l.query||"",s)),bucketAggs:l.bucketAggs?.map(n)}));return JSON.parse(this.templateSrv.replace(JSON.stringify(a),s))}testDatasource(){return(0,ge.n)(this.getFields(["date"]).pipe((0,Gt.z)(e=>(0,E.find)(e,{text:this.timeField})?(0,Ie.of)({status:"success",message:"Index OK. Time field name OK."}):(0,Ie.of)({status:"error",message:"No date field named "+this.timeField+" found"})),(0,at.K)(e=>(console.error(e),e.message?(0,Ie.of)({status:"error",message:e.message}):(0,Ie.of)({status:"error",message:e.status})))))}getQueryHeader(e,s,n){const a={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(s,n)};return JSON.stringify(a)}getQueryDisplayText(e){const s=e.metrics,n=e.bucketAggs;let a="";return e.query&&(a+="Query: "+e.query+", "),a+="Metrics: ",a+=s?.reduce((r,l)=>{let c=C[l.type].label+"(";return w(l)&&(c+=l.field),q(l)&&(c+=xe(l).replace(new RegExp("params.","g"),"")),c+="), ",`${r} ${c}`},""),a+=n?.reduce((r,l,u)=>{const c=A[l.type];let d="";return u===0&&(d+=" Group by: "),d+=c.label+"(",Pt(l)&&(d+=l.field),`${r} ${d}), `},""),e.alias&&(a+="Alias: "+e.alias),a}showContextToggle(){return!0}getDataProvider(e,s){if(this.getSupportedSupplementaryQueryTypes().includes(e))switch(e){case Ve.v8.LogsVolume:return this.getLogsVolumeDataProvider(s);default:return}}getSupportedSupplementaryQueryTypes(){return[Ve.v8.LogsVolume]}getSupplementaryQuery(e,s){if(!this.getSupportedSupplementaryQueryTypes().includes(e))return;let n=!1;switch(e){case Ve.v8.LogsVolume:if(n=s.metrics?.length===1&&s.metrics[0].type==="logs",!n)return;const a=[],r=this.timeField??"@timestamp";return this.logLevelField&&a.push({id:"2",type:"terms",settings:{min_doc_count:"0",size:"0",order:"desc",orderBy:"_count",missing:Ve.in.unknown},field:this.logLevelField}),a.push({id:"3",type:"date_histogram",settings:{interval:"auto",min_doc_count:"0",trimEdges:"0"},field:r}),{refId:`${ls}${s.refId}`,query:s.query,metrics:[{type:"count",id:"1"}],timeField:r,bucketAggs:a};default:return}}getLogsVolumeDataProvider(e){const s=(0,E.cloneDeep)(e),n=s.targets.map(a=>this.getSupplementaryQuery(Ve.v8.LogsVolume,a)).filter(a=>!!a);if(n.length)return(0,Hn.Bz)(this,{...s,targets:n},{range:e.range,targets:e.targets,extractLevel:a=>(0,Un.jx)(a.name||"")})}query(e){if(e.app===it.zj.Explore&&Zt.v.featureToggles.elasticsearchBackendMigration){const m=new Date;return super.query(e).pipe((0,Yt.b)(h=>rs(h,e,m)))}let n="";const a=this.interpolateVariablesInQueries((0,E.cloneDeep)(e.targets),e.scopedVars),r=[];let l=a.some(m=>We(m,"logs"));const u=this.templateSrv.getAdhocFilters(this.name),c=[];for(const m of a){if(m.hide)continue;let h;if(We(m,"logs")){m.bucketAggs=[de()];const me=m.metrics?.find($=>$.type==="logs"),X=me.settings?.limit?parseInt(me.settings?.limit,10):500;c.push(X),m.metrics=[],h=this.queryBuilder.getLogsQuery(m,X,u)}else c.push(),m.alias&&(m.alias=this.interpolateLuceneQuery(m.alias,e.scopedVars)),h=this.queryBuilder.build(m,u);const x=JSON.stringify(h),z="query_then_fetch",G=this.getQueryHeader(z,e.range.from,e.range.to);n+=G+`
`,n+=x+`
`,r.push(m)}if(r.length===0)return(0,Ie.of)({data:[]});n=n.replace(/"\$timeFrom"/g,e.range.from.valueOf().toString()),n=n.replace(/"\$timeTo"/g,e.range.to.valueOf().toString()),n=this.templateSrv.replace(n,e.scopedVars);const d=this.getMultiSearchUrl(),g=new Date;return this.post(d,n).pipe((0,we.U)(m=>{const h=new ts(r,m);if(l){const x=h.getLogs(this.logMessageField,this.logLevelField);return x.data.forEach((z,G)=>{ma(z,this.dataLinks,c[G])}),x}return h.getTimeSeries()}),(0,Yt.b)(m=>rs(m,e,g)))}isMetadataField(e){return da.includes(e)}getFields(e,s){const n={float:"number",double:"number",integer:"number",long:"number",date:"date",date_nanos:"date",string:"string",text:"string",scaled_float:"number",nested:"nested",histogram:"number"};return this.get("/_mapping",s).pipe((0,we.U)(a=>{const r=(d,g)=>this.isMetadataField(g)?!1:!e||e.length===0?!0:e.includes(d.type)||e.includes(n[d.type]),l=[],u={};function c(d){for(const g in d){const m=d[g];if((0,E.isObject)(m.properties)&&(l.push(g),c(m.properties)),(0,E.isObject)(m.fields)&&(l.push(g),c(m.fields)),(0,E.isString)(m.type)){const h=l.concat(g).join(".");r(m,g)&&(u[h]={text:h,type:m.type})}}l.pop()}for(const d in a){const g=a[d];if(g&&g.mappings){const h=g.mappings.properties;c(h)}}return(0,E.map)(u,d=>d)}))}getTerms(e,s=(0,K.JK)()){const n="query_then_fetch",a=this.getQueryHeader(n,s.from,s.to);let r=JSON.stringify(this.queryBuilder.getTermsQuery(e));r=r.replace(/\$timeFrom/g,s.from.valueOf().toString()),r=r.replace(/\$timeTo/g,s.to.valueOf().toString()),r=a+`
`+r+`
`;const l=this.getMultiSearchUrl();return this.post(l,r).pipe((0,we.U)(u=>{if(!u.responses[0].aggregations)return[];const c=u.responses[0].aggregations[1].buckets;return(0,E.map)(c,d=>({text:d.key_as_string||d.key,value:d.key}))}))}getMultiSearchUrl(){const e=new URLSearchParams;return this.maxConcurrentShardRequests&&e.append("max_concurrent_shard_requests",`${this.maxConcurrentShardRequests}`),this.xpack&&this.includeFrozen&&e.append("ignore_throttled","false"),("_msearch?"+e.toString()).replace(/\?$/,"")}metricFindQuery(e,s){const n=s?.range,a=JSON.parse(e);if(e){if(a.find==="fields")return a.type=this.interpolateLuceneQuery(a.type),(0,ge.n)(this.getFields(a.type,n));if(a.find==="terms")return a.field=this.interpolateLuceneQuery(a.field),a.query=this.interpolateLuceneQuery(a.query),(0,ge.n)(this.getTerms(a,n))}return Promise.resolve([])}getTagKeys(){return(0,ge.n)(this.getFields())}getTagValues(e){const s=this.timeSrv.timeRange();return(0,ge.n)(this.getTerms({field:e.key},s))}targetContainsTemplate(e){if(this.templateSrv.containsTemplate(e.query)||this.templateSrv.containsTemplate(e.alias))return!0;for(const s of e.bucketAggs)if(this.templateSrv.containsTemplate(s.field)||this.objectContainsTemplate(s.settings))return!0;for(const s of e.metrics)if(this.templateSrv.containsTemplate(s.field)||this.objectContainsTemplate(s.settings)||this.objectContainsTemplate(s.meta))return!0;return!1}isPrimitive(e){return!!(e==null||["string","number","boolean"].some(s=>s==="boolean"))}objectContainsTemplate(e){if(!e)return!1;for(const s of Object.keys(e))if(this.isPrimitive(e[s])){if(this.templateSrv.containsTemplate(e[s]))return!0}else if(Array.isArray(e[s])){for(const n of e[s])if(this.objectContainsTemplate(n))return!0}else if(this.objectContainsTemplate(e[s]))return!0;return!1}modifyQuery(e,s){if(!s.options)return e;let n=e.query??"";switch(s.type){case"ADD_FILTER":{n.length>0&&(n+=" AND "),n+=`${s.options.key}:"${s.options.value}"`;break}case"ADD_FILTER_OUT":{n.length>0&&(n+=" AND "),n+=`-${s.options.key}:"${s.options.value}"`;break}}return{...e,query:n}}addAdHocFilters(e){const s=this.templateSrv.getAdhocFilters(this.name);if(s.length===0)return e;const n=s.map(r=>{const{key:l,operator:u,value:c}=r;if(!(!l||!c))switch(u){case"=":return`${l}:"${c}"`;case"!=":return`-${l}:"${c}"`;case"=~":return`${l}:/${c}/`;case"!~":return`-${l}:/${c}/`;case">":return`${l}:>${c}`;case"<":return`${l}:<${c}`}});return[e,...n].filter(r=>r).join(" AND ")}}function ma(t,e,s){if(s&&(t.meta={...t.meta,limit:s}),!!e.length)for(const n of t.fields){const a=e.filter(r=>new RegExp(r.field).test(n.name));a.length!==0&&(n.config=n.config||{},n.config.links=[...(n.config.links,a.map(pa))])}}function pa(t){const e=(0,zn.F)();if(t.datasourceUid){const s=e.getInstanceSettings(t.datasourceUid);return{title:t.urlDisplayLabel||"",url:"",internal:{query:{query:t.url},datasourceUid:t.datasourceUid,datasourceName:s?.name??"Data source not found"}}}else return{title:t.urlDisplayLabel||"",url:t.url}}function fa(t,e){if(e==="desc")return t;const s=t.responses[0];return{...t,responses:[{...s,hits:{...s.hits,hits:s.hits.hits.reverse()}}]}}const ha=new L.hf(ga).setQueryEditor(gn).setConfigEditor(jn);(0,_.N$)().subscribe(pe.Pl,la)},77172:(Le,O,f)=>{var L;L={value:!0};var pe,_=f(68404),p=(pe=_)&&typeof pe=="object"&&"default"in pe?pe.default:pe,i=f(40419),K=f(24034),be=f(82897);const re=["af-south-1","ap-east-1","ap-northeast-1","ap-northeast-2","ap-northeast-3","ap-south-1","ap-southeast-1","ap-southeast-2","ca-central-1","cn-north-1","cn-northwest-1","eu-central-1","eu-north-1","eu-west-1","eu-west-2","eu-west-3","me-south-1","sa-east-1","us-east-1","us-east-2","us-gov-east-1","us-gov-west-1","us-iso-east-1","us-isob-east-1","us-west-1","us-west-2"];var ce;(ce=O._e||(O._e={})).Keys="keys",ce.Credentials="credentials",ce.Default="default",ce.EC2IAMRole="ec2_iam_role",ce.ARN="arn";const fe=[{label:"Workspace IAM Role",value:O._e.EC2IAMRole},{label:"AWS SDK Default",value:O._e.Default},{label:"Access & secret key",value:O._e.Keys},{label:"Credentials file",value:O._e.Credentials}],v=o=>({value:o,label:o}),M=o=>{var b,y,S,D,w,F,q,P;const[N,T]=_.useState((o.standardRegions||re).map(v)),{loadRegions:R,onOptionsChange:ie,skipHeader:ue=!1,skipEndpoint:C=!1}=o,{labelWidth:Z=28,options:I}=o;let W=I.jsonData.profile;W===void 0&&(W=I.database);const he=window.grafanaBootData.settings,se=_.useMemo(()=>{var k;return(k=he.awsAllowedAuthProviders)!==null&&k!==void 0?k:[O._e.Default,O._e.Keys,O._e.Credentials]},[he.awsAllowedAuthProviders]),Se=(b=he.awsAssumeRoleEnabled)===null||b===void 0||b,de=fe.find(k=>k.value===I.jsonData.authType);return _.useEffect(()=>{!de&&se.length&&ie(Object.assign(Object.assign({},I),{jsonData:Object.assign(Object.assign({},I.jsonData),{authType:se[0]})}))},[de,I,ie,se]),_.useEffect(()=>{R&&R().then(k=>T(k.map(v)))},[R]),p.createElement(i.FieldSet,{label:ue?"":"Connection Details","data-testid":"connection-config"},p.createElement(i.InlineField,{label:"Authentication Provider",labelWidth:Z,tooltip:"Specify which AWS credentials chain to use."},p.createElement(i.Select,{"aria-label":"Authentication Provider",className:"width-30",value:de,options:fe.filter(k=>se.includes(k.value)),defaultValue:I.jsonData.authType,onChange:k=>{K.onUpdateDatasourceJsonDataOptionSelect(o,"authType")(k)},menuShouldPortal:!0})),I.jsonData.authType==="credentials"&&p.createElement(i.InlineField,{label:"Credentials Profile Name",labelWidth:Z,tooltip:"Credentials profile name, as specified in ~/.aws/credentials, leave blank for default."},p.createElement(i.Input,{"aria-label":"Credentials Profile Name",className:"width-30",placeholder:"default",value:W,onChange:K.onUpdateDatasourceJsonDataOption(o,"profile")})),I.jsonData.authType==="keys"&&p.createElement(p.Fragment,null,p.createElement(i.InlineField,{label:"Access Key ID",labelWidth:Z},!((y=o.options.secureJsonFields)===null||y===void 0)&&y.accessKey?p.createElement(i.ButtonGroup,{className:"width-30"},p.createElement(i.Input,{disabled:!0,placeholder:"Configured"}),p.createElement(i.ToolbarButton,{icon:"edit",tooltip:"Edit Access Key ID",type:"button",onClick:K.onUpdateDatasourceResetOption(o,"accessKey")})):p.createElement(i.Input,{"aria-label":"Access Key ID",className:"width-30",value:(D=(S=I.secureJsonData)===null||S===void 0?void 0:S.accessKey)!==null&&D!==void 0?D:"",onChange:K.onUpdateDatasourceSecureJsonDataOption(o,"accessKey")})),p.createElement(i.InlineField,{label:"Secret Access Key",labelWidth:Z},!((w=o.options.secureJsonFields)===null||w===void 0)&&w.secretKey?p.createElement(i.ButtonGroup,{className:"width-30"},p.createElement(i.Input,{disabled:!0,placeholder:"Configured"}),p.createElement(i.ToolbarButton,{icon:"edit",type:"button",tooltip:"Edit Secret Access Key",onClick:K.onUpdateDatasourceResetOption(o,"secretKey")})):p.createElement(i.Input,{"aria-label":"Secret Access Key",className:"width-30",value:(q=(F=I.secureJsonData)===null||F===void 0?void 0:F.secretKey)!==null&&q!==void 0?q:"",onChange:K.onUpdateDatasourceSecureJsonDataOption(o,"secretKey")}))),Se&&p.createElement(p.Fragment,null,p.createElement(i.InlineField,{label:"Assume Role ARN",labelWidth:Z,tooltip:"Optionally, specify the ARN of a role to assume. Specifying a role here will ensure that the selected authentication provider is used to assume the specified role rather than using the credentials directly. Leave blank if you don't need to assume a role at all"},p.createElement(i.Input,{"aria-label":"Assume Role ARN",className:"width-30",placeholder:"arn:aws:iam:*",value:I.jsonData.assumeRoleArn||"",onChange:K.onUpdateDatasourceJsonDataOption(o,"assumeRoleArn")})),p.createElement(i.InlineField,{label:"External ID",labelWidth:Z,tooltip:"If you are assuming a role in another account, that has been created with an external ID, specify the external ID here."},p.createElement(i.Input,{"aria-label":"External ID",className:"width-30",placeholder:"External ID",value:I.jsonData.externalId||"",onChange:K.onUpdateDatasourceJsonDataOption(o,"externalId")}))),!C&&p.createElement(i.InlineField,{label:"Endpoint",labelWidth:Z,tooltip:"Optionally, specify a custom endpoint for the service"},p.createElement(i.Input,{"aria-label":"Endpoint",className:"width-30",placeholder:(P=o.defaultEndpoint)!==null&&P!==void 0?P:"https://{service}.{region}.amazonaws.com",value:I.jsonData.endpoint||"",onChange:K.onUpdateDatasourceJsonDataOption(o,"endpoint")})),p.createElement(i.InlineField,{label:"Default Region",labelWidth:Z,tooltip:"Specify the region, such as for US West (Oregon) use ` us-west-2 ` as the region."},p.createElement(i.Select,{"aria-label":"Default Region",className:"width-30",value:N.find(k=>k.value===I.jsonData.defaultRegion),options:N,defaultValue:I.jsonData.defaultRegion,allowCustomValue:!0,onChange:K.onUpdateDatasourceJsonDataOptionSelect(o,"defaultRegion"),formatCreateLabel:k=>"Use region: "+k,menuShouldPortal:!0})),o.children)};/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function _e(o,b,y,S){return new(y||(y=Promise))(function(D,w){function F(N){try{P(S.next(N))}catch(T){w(T)}}function q(N){try{P(S.throw(N))}catch(T){w(T)}}function P(N){var T;N.done?D(N.value):(T=N.value,T instanceof y?T:new y(function(R){R(T)})).then(F,q)}P((S=S.apply(o,b||[])).next())})}function Ee(o){const[b,y]=_.useState(o.value||o.default||null),[S,D]=_.useState(b?[b]:[]),[w,F]=_.useState(o.dependencies),[q,P]=_.useState(!1),[N,T]=_.useState(!1),R=_.useMemo(()=>{const I=[{label:`default (${o.default})`,value:"__default",description:"Default value set in the data source"}];return o.value&&o.value!=="__default"&&I.push({label:o.value,value:o.value}),I},[o.default,o.value]),[ie,ue]=_.useState(o.default?R:[]);_.useEffect(()=>{o.resources!==void 0&&D(o.resources)},[o.resources]),_.useEffect(()=>{const I=o.default?R:[];S.length?(S.forEach(W=>{const he=typeof W=="string"?W:W.value;I.find(se=>se.value===he)||(typeof W=="string"?I.push({label:W,value:W}):I.push(W))}),ue(I)):ue([])},[S,R,o.default]),_.useEffect(()=>{be.isEqual(o.dependencies,w)||(T(!1),y(null),o.onChange(null),F(o.dependencies))},[o,w]);const C=()=>_e(this,void 0,void 0,function*(){if(!N){o.saveOptions&&(yield o.saveOptions());try{const I=yield o.fetch();D(I)}finally{T(!0)}}}),Z=()=>_e(this,void 0,void 0,function*(){P(!0);try{yield C()}finally{P(!1)}});return p.createElement(i.InlineField,{label:o.label,labelWidth:o.labelWidth,tooltip:o.tooltip,hidden:o.hidden},p.createElement("div",{"data-testid":o["data-testid"],title:o.title},p.createElement(i.Select,Object.assign({},o,{"aria-label":o.label,options:ie,onChange:I=>{o.onChange(I),I.value&&y(I.value)},isLoading:q,className:o.className||"min-width-6",onOpenMenu:()=>o.fetch&&Z(),menuShouldPortal:!0}))))}var le;(le=O.rB||(O.rB={}))[le.Previous=0]="Previous",le[le.Null=1]="Null",le[le.Value=2]="Value";const j=[{label:"Previous Value",value:O.rB.Previous},{label:"NULL",value:O.rB.Null},{label:"Value",value:O.rB.Value}];function Te(o){return typeof o=="string"?o:o.map(b=>function(y){return"'"+String(y).replace(/'/g,"''")+"'"}(b)).join(",")}L=function(o){var b,y,S;const{jsonData:D}=o.options,w={title:D.defaultRegion?"":"select a default region",labelWidth:(b=o.labelWidth)!==null&&b!==void 0?b:28,className:"width-30"},F=[o.options.jsonData.assumeRoleArn,o.options.jsonData.authType,o.options.jsonData.defaultRegion,o.options.jsonData.endpoint,o.options.jsonData.externalId,o.options.jsonData.profile,(y=o.options.secureJsonData)===null||y===void 0?void 0:y.accessKey,(S=o.options.secureJsonData)===null||S===void 0?void 0:S.secretKey].concat(o.dependencies);return p.createElement(Ee,Object.assign({label:o.label,"data-testid":o["data-testid"],onChange:o.onChange,fetch:o.fetch,value:o.value,saveOptions:o.saveOptions,dependencies:F,hidden:o.hidden,disabled:o.disabled||!D.defaultRegion,allowCustomValue:o.allowCustomValue,autoFocus:o.autoFocus,backspaceRemovesValue:o.backspaceRemovesValue,className:o.className,invalid:o.invalid,isClearable:o.isClearable,isMulti:o.isMulti,inputId:o.inputId,showAllSelectedWhenOpen:o.showAllSelectedWhenOpen,maxMenuHeight:o.maxMenuHeight,minMenuHeight:o.minMenuHeight,maxVisibleValues:o.maxVisibleValues,menuPlacement:o.menuPlacement,menuPosition:o.menuPosition,noOptionsMessage:o.noOptionsMessage,onBlur:o.onBlur,onCreateOption:o.onCreateOption,onInputChange:o.onInputChange,placeholder:o.placeholder,width:o.width,isOptionDisabled:o.isOptionDisabled},w))},O.ConnectionConfig=M,L=function(o){var b,y,S;return p.createElement(p.Fragment,null,p.createElement(i.InlineField,{label:"Fill value",tooltip:"value to fill missing points"},p.createElement(i.Select,{"aria-label":"Fill value",options:j,value:(y=(b=o.query.fillMode)===null||b===void 0?void 0:b.mode)!==null&&y!==void 0?y:O.rB.Previous,onChange:({value:D})=>{var w;o.onChange(Object.assign(Object.assign({},o.query),{fillMode:Object.assign(Object.assign({},o.query.fillMode),{mode:D})})),(w=o.onRunQuery)===null||w===void 0||w.call(o)},className:"width-12",menuShouldPortal:!0})),((S=o.query.fillMode)===null||S===void 0?void 0:S.mode)===O.rB.Value&&p.createElement(i.InlineField,{label:"Value",labelWidth:11},p.createElement(i.Input,{type:"number","aria-label":"Value",value:o.query.fillMode.value,onChange:({currentTarget:D})=>o.onChange(Object.assign(Object.assign({},o.query),{fillMode:{mode:O.rB.Value,value:D.valueAsNumber}})),onBlur:()=>{var D;return(D=o.onRunQuery)===null||D===void 0?void 0:D.call(o)}})))},L=function(o){return p.createElement(i.InlineField,{label:"Format as",labelWidth:11},p.createElement(i.Select,{"aria-label":"Format as",options:o.options,value:o.query.format,onChange:b=>{var y;o.onChange(Object.assign(Object.assign({},o.query),{format:b.value||0})),(y=o.onRunQuery)===null||y===void 0||y.call(o)},className:"width-12",menuShouldPortal:!0}))},L=function(o){var b;return p.createElement(i.InlineField,{label:o.label,labelWidth:(b=o.labelWidth)!==null&&b!==void 0?b:28,tooltip:o.tooltip,hidden:o.hidden,disabled:o.disabled},p.createElement(i.Input,{"data-testid":o["data-testid"],className:"width-30",value:o.value,onChange:o.onChange,placeholder:o.placeholder,disabled:o.disabled}))},L=function(o){const{getSuggestions:b,query:y}=o,{rawSQL:S}=be.defaults(o.query,{rawSQL:""}),D=_.useRef([]);return _.useEffect(()=>{D.current=b(y)},[b,y]),p.createElement(i.CodeEditor,Object.assign({language:o.language,value:S,onBlur:w=>{const F=Object.assign(Object.assign({},o.query),{rawSQL:w});o.onChange(F),o.onRunQuery()},showMiniMap:!1,showLineNumbers:!0,getSuggestions:()=>D.current,height:"240px"},o.editorProps))},L=Ee,O.SIGV4ConnectionConfig=o=>{var b,y,S,D;const{onOptionsChange:w,options:F}=o,q={onOptionsChange:P=>{var N,T,R,ie;const ue=Object.assign(Object.assign({},F),{jsonData:Object.assign(Object.assign({},F.jsonData),{sigV4AuthType:P.jsonData.authType,sigV4Profile:P.jsonData.profile,sigV4AssumeRoleArn:P.jsonData.assumeRoleArn,sigV4ExternalId:P.jsonData.externalId,sigV4Region:P.jsonData.defaultRegion,sigV4Endpoint:P.jsonData.endpoint}),secureJsonFields:{sigV4AccessKey:(N=P.secureJsonFields)===null||N===void 0?void 0:N.accessKey,sigV4SecretKey:(T=P.secureJsonFields)===null||T===void 0?void 0:T.secretKey},secureJsonData:{sigV4AccessKey:(R=P.secureJsonData)===null||R===void 0?void 0:R.accessKey,sigV4SecretKey:(ie=P.secureJsonData)===null||ie===void 0?void 0:ie.secretKey}});w(ue)},options:Object.assign(Object.assign({},F),{jsonData:Object.assign(Object.assign({},F.jsonData),{authType:F.jsonData.sigV4AuthType,profile:F.jsonData.sigV4Profile,assumeRoleArn:F.jsonData.sigV4AssumeRoleArn,externalId:F.jsonData.sigV4ExternalId,defaultRegion:F.jsonData.sigV4Region,endpoint:F.jsonData.sigV4Endpoint}),secureJsonFields:{accessKey:(b=F.secureJsonFields)===null||b===void 0?void 0:b.sigV4AccessKey,secretKey:(y=F.secureJsonFields)===null||y===void 0?void 0:y.sigV4SecretKey},secureJsonData:{accessKey:(S=F.secureJsonData)===null||S===void 0?void 0:S.sigV4AccessKey,secretKey:(D=F.secureJsonData)===null||D===void 0?void 0:D.sigV4SecretKey}})};return p.createElement(p.Fragment,null,p.createElement("div",{className:"gf-form"},p.createElement("h6",null,"SigV4 Auth Details")),p.createElement(M,Object.assign({},q,{skipHeader:!0,skipEndpoint:!0})))},L=(o,b)=>{const y=o(),S=[];return y.getVariables().forEach(D=>{const w="$"+D.name;let F=y.replace(w);F===w&&(F=""),S.push({label:w,kind:i.CodeEditorSuggestionItemKind.Text,detail:"(Template Variable) "+F})}),b.concat(S)},L=function(o,b,y){const S=y();return Object.assign(Object.assign({},o),{rawSQL:S.replace(o.rawSQL,b,Te)})},L=fe,L=function(o){return!!o.rawSQL},L=re},37308:(Le,O,f)=>{"use strict";Le.exports=f(77172)}}]);

//# sourceMappingURL=4601.3717dc54abef5c27ade5.js.map